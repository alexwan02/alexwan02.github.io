<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
          Android：Activity的基础知识及启动过程 - Alex Studio
        
    </title>

    <link rel="canonical" href="http://blog.alexwan.cn/2016/06/05/Android：Activity的基础知识及启动过程/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/hux-blog.min.css">

    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css">

    <!-- Custom Fonts -->
    <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Alex Studio</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>

                    

                        
                    

                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/archives/">Archives</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/tags/">Tags</a>
                        </li>
                        
                    
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Main Content -->
    
<!-- Image to hack wechat -->
<!-- <img src="http://blog.alexwan.cn/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="{{ site.baseurl }}/{% if page.header-img %}{{ page.header-img }}{% else %}{{ site.header-img }}{% endif %}" width="0" height="0"> -->

<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        background-image: url('/img/home-bg.jpg')
    }
</style>
<header class="intro-header" >
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                          <a class="tag" href="/tags/#android-aosp" title="android-aosp">android-aosp</a>
                        
                    </div>
                    <h1>Android：Activity的基础知识及启动过程</h1>
                    <h2 class="subheading"></h2>
                    <span class="meta">
                        Posted by AlexWan on
                        2016-06-05
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <p>Activity是Android四个基本组件之一，主要用作Application的界面展示和交互。Activity可以说是Android中应用最多的组件，因此有必要掌握关于Activity的知识。如：Activity的生命周期，Activity的启动模式，更深层次的如Activity的创建过程以及Actvity生命周期对应的方法是如何调用的。</p>
<h1 id="一、Activity的生命周期"><a href="#一、Activity的生命周期" class="headerlink" title="一、Activity的生命周期"></a>一、Activity的生命周期</h1><h2 id="1-正常生命周期"><a href="#1-正常生命周期" class="headerlink" title="1.正常生命周期"></a>1.正常生命周期</h2><p>一个Activity正常的流程如下图：</p>
<div><br><image src="http://res.cloudinary.com/dmfz9aun7/image/upload/v1467529027/android/activity_lifecycle.png" style="width:50%"><br></image></div>

<p>1.Activity的完整生命周期：从onCreate()开始到onDestory()结束。Activity在onCreate()中完成一系列初始化的工作，如完成界面布局资源的加载，初始化Activity的需要的数据等等。在onDestory()中释放所有包含的资源。如在结束Actviity时，如果Activity中还有未完成的数据加载的工作，就需要在onDestory()中或之前及时结束。</p>
<p>2.Activity的<code>可见</code>生命周期：<code>可见</code>生命周期在onStart()与onStop()之间。这段周期中，用户可以看到activity出现在屏幕上，并在onResume()之后，用户可以与界面交互了。当前Activity调用onStop()后，则不再可见，如启动一个新的Activity。在这段生命周期中，你可以添加资源到activity中，向用户展示。如：你在onStart中注册了一个广播，来更新你的UI，然后当activity不可见时，在onStop()中注销这个广播，释放广播资源。在activity整个生命周期中，onStart()和onStop()可能会多次调用，因为activity会在可见和不可见之间多次变化。注：onStart()和onStop()中不要做耗时操作，影响Actvitiy的<br>显示与停止。</p>
<p>3.Activity前台展示时的生命周期：这段生命周期在调用onResume()和onPause()之间。这段周期，当前Actvitiy位于所有其他Activity顶部（因为Actvitiy就是保存在栈形式的结构中）。Actviity会频繁地在前台的进入和退出之间交互，比如：当回到Android的Home页面、设备处于休眠状态或显示Dialog时，都会调用onPause()，停止当前Actvity的前台状态。因为Actvitiy比较频繁在前台展示的状态交互，在这两方法中，不能进行耗时任务，也是因为新的Actvitiy在显示时，需要暂停前一个Actvitiy的执行，才会调用本身onResume()方法。</p>
<h2 id="2-异常时的生命周期"><a href="#2-异常时的生命周期" class="headerlink" title="2.异常时的生命周期"></a>2.异常时的生命周期</h2><p>这里还需要考虑到，当系统内存不够用时或旋转屏幕时，Activity会经历哪些生命周期？</p>
<div><br><image src="http://res.cloudinary.com/dmfz9aun7/image/upload/v1467533421/android/restore_instance.png" style="width:50%"><br></image></div>

<p>当系统在内存不够用的时候，系统会销毁后台的Activity以来提供足够内存资源给前台的Actvitiy使用，所以在这种情况下，后台的Activity已经被销毁，回到前台时，系统不仅仅只调用onResume()等方法，系统必须重新创建Activity对象。然而用户不会意识到系统销毁了之前Actviity并重新创建了一个新的。因此开发时某时候需要恢复到之前Actvitiy状态：包括数据、界面资源状态等。这时候需要你的Activity覆写Actvity的 onSaveInstanceState()方法，来存储Activity销毁时的数据。</p>
<figure class="highlight java"><figcaption><span>Actvity.java</span></figcaption><table><tr><td class="code"><pre><div class="line"><span class="comment">// 这个方法在onStop()之前调用。</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onSaveInstanceState</span><span class="params">(Bundle outState)</span> </span>&#123;</div><div class="line">    <span class="comment">// 委托Window保存数据</span></div><div class="line">    outState.putBundle(WINDOW_HIERARCHY_TAG, mWindow.saveHierarchyState());</div><div class="line">    Parcelable p = mFragments.saveAllState();</div><div class="line">    <span class="keyword">if</span> (p != <span class="keyword">null</span>) &#123;</div><div class="line">        outState.putParcelable(FRAGMENTS_TAG, p);</div><div class="line">    &#125;</div><div class="line">    getApplication().dispatchActivitySaveInstanceState(<span class="keyword">this</span>, outState);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>系统默认保存当前Activity的视图结构。并在Actvitiy重启后恢复这些数据。首先Actvitiy会调用onSaveInstanceState保存数据，然后Actvitiy会委托Window保存数据，Window委托它上面的顶级容器去保存数据。顶级容器是一个ViewGroup，一般情况下是DecorView。最后顶层容器再去一一通知它的子元素来保存数据。</p>
<figure class="highlight java"><figcaption><span>PhoneWindow.java</span></figcaption><table><tr><td class="code"><pre><div class="line"><span class="comment">// PhoneWindow.java 是Window的实现</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> Bundle <span class="title">saveHierarchyState</span><span class="params">()</span> </span>&#123;</div><div class="line">    Bundle outState = <span class="keyword">new</span> Bundle();</div><div class="line">    <span class="keyword">if</span> (mContentParent == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">return</span> outState;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// mContentParent就是ViewGroup</span></div><div class="line">    mContentParent.saveHierarchyState(states);</div><div class="line">    ...</div><div class="line">    <span class="keyword">return</span> outState;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><figcaption><span>ViewGroup.java</span></figcaption><table><tr><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">// 分发的每个子View的dispatchSaveInstanceState具体实现</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dispatchSaveInstanceState</span><span class="params">(SparseArray&lt;Parcelable&gt; container)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.dispatchSaveInstanceState(container);</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> count = mChildrenCount;</div><div class="line">    <span class="keyword">final</span> View[] children = mChildren;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">        View c = children[i];</div><div class="line">        <span class="keyword">if</span> ((c.mViewFlags &amp; PARENT_SAVE_DISABLED_MASK) != PARENT_SAVE_DISABLED) &#123;</div><div class="line">            c.dispatchSaveInstanceState(container);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当Actvitiy被重新创建后，系统会调用onRestoreInstanceState，并把Actvitiy销毁时onSaveInstanceState方法所保存的Bundle对象作为参数同时传递给onRestoreInstanceState和onCreate方法。<br><figure class="highlight java"><figcaption><span>Actvity.java</span></figcaption><table><tr><td class="code"><pre><div class="line"><span class="comment">// 这个方法在onStart和onPostCreate()之前调用</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onRestoreInstanceState</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (mWindow != <span class="keyword">null</span>) &#123;</div><div class="line">        Bundle windowState = savedInstanceState.getBundle(WINDOW_HIERARCHY_TAG);</div><div class="line">        <span class="keyword">if</span> (windowState != <span class="keyword">null</span>) &#123;</div><div class="line">            mWindow.restoreHierarchyState(windowState);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在恢复Actvitiy存储时的数据时候，接收的位置可以选择onRestoreInstanceState()或者onCreate，两者区别是onRestoreInstanceState()中的Bundle不为空，onCreate()中的Bundle值可能为空，需要加上判断。</p>
<blockquote>
<p><code>注</code>：onSaveInstanceState()并不能保证正常时被调用。所以不要用来做为数据存储持久化的工作。相反的，当用户离开Activity时应该在onPause()中来存储持久化数据（如数据库数据）。可以简单理解为系统只在Actvitiy异常终止的时候才会调用这两方法，其他情况并不会触发。异常终止：如因为内存不足导致低优先级的Actvitiy被销毁、在旋转屏幕的时候Actvitiy被销毁又被重新创建。</p>
</blockquote>
<h2 id="3-处理系统配置变化"><a href="#3-处理系统配置变化" class="headerlink" title="3.处理系统配置变化"></a>3.处理系统配置变化</h2><p>一些系统配置在运行时可能会发生变化（如：屏幕旋转、键盘变化、语言等）。当这些变化发生的时候，系统会调用onDestroy(),然后立即调用onCreate()。有时候我们并不想要销毁Actvitiy和重新创建，这时候我们可以在AndroidManifest中配置指定Activity的<code>android:configChanges</code>的属性即可<br><figure class="highlight xml"><figcaption><span>AndroidManifest.xml</span></figcaption><table><tr><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">activity</span> </span></div><div class="line">    <span class="attr">...</span></div><div class="line">    <span class="attr">android:configChanges</span>=<span class="string">[</span>"<span class="attr">mcc</span>", "<span class="attr">mnc</span>", "<span class="attr">locale</span>",</div><div class="line">                         "<span class="attr">touchscreen</span>", "<span class="attr">keyboard</span>", "<span class="attr">keyboardHidden</span>",</div><div class="line">                         "<span class="attr">navigation</span>", "<span class="attr">screenLayout</span>", "<span class="attr">fontScale</span>",</div><div class="line">                         "<span class="attr">uiMode</span>", "<span class="attr">orientation</span>", "<span class="attr">screenSize</span>",</div><div class="line">                         "<span class="attr">smallestScreenSize</span>"] </div><div class="line">    <span class="attr">...</span> &gt;</div><div class="line">    ...</div><div class="line"><span class="tag">&lt;/<span class="name">activity</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>常用的三个选项：</p>
<pre><code>1. local：系统语言变化、
2. orientation：手机屏幕发生旋转、
3. keyboardHidden：键盘的可访问性发生了变化，调出键盘。
</code></pre><p>使用方法</p>
<figure class="highlight xml"><figcaption><span>AndroidManifest.xml</span></figcaption><table><tr><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">activity</span></span></div><div class="line">	<span class="attr">android:configChanges</span>=<span class="string">"orientation|..."</span></div><div class="line">	<span class="attr">...</span> &gt;</div><div class="line">	...</div><div class="line"><span class="tag">&lt;/<span class="name">activity</span>&gt;</span></div></pre></td></tr></table></figure>
<blockquote>
<p><code>注</code>：screenSize、smallestScreenSize比较特殊，它们的行为与编译选项有关，和运行环境无关。</p>
</blockquote>
<figure class="highlight xml"><figcaption><span>AndroidManifest.xml</span></figcaption><table><tr><td class="code"><pre><div class="line"><span class="comment">&lt;!--如果指定的minSdkVersion和targetSdkVersion有一个大于13，为了防止旋转屏幕时Actvitiy重启，除了 --&gt;</span></div><div class="line"><span class="comment">&lt;!-- orientation，还需要加上screenSize和smallestScreenSize --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">uses-sdk</span></span></div><div class="line">    <span class="attr">android:minSdkVersion</span>=<span class="string">"..."</span></div><div class="line">    <span class="attr">android:targetSdkVersion</span>=<span class="string">"..."</span></div><div class="line">    /&gt;</div></pre></td></tr></table></figure>
<h1 id="二、Activity的启动模式"><a href="#二、Activity的启动模式" class="headerlink" title="二、Activity的启动模式"></a>二、Activity的启动模式</h1><p>为了方便管理Activity，Android引入了Task（任务）和Stack（返回栈）<br>Task（任务）是用户进行交互的Activity集合。Activity置于类似<code>后进先出</code>的对象结构的Stack（返回栈）中。</p>
<ul>
<li>当用户点击Application（应用程序）的Icon时，如果应用的Task没有创建，则系统创建一个新的Task，Application打开Main Activity作为Task的根activity。</li>
<li>当启动新的Activity时，创建Activity的实例放入栈，置于栈顶并获取焦点。</li>
<li>当Activity进入停止状态，系统保持它的当前状态。</li>
<li>当用户点击返回按钮时，栈顶Activity出栈，调用onDestory()销毁实例。前Activity恢复存储的状态并置于栈顶。栈中的Activities不会重新排序，只能够被压入栈和出栈。</li>
<li>当用户连续点击返回键，栈中Activity接连出栈，直到回到桌面或Task运行的起始位置。所有activity都被从栈中移除时，则Task销毁。</li>
<li>当启动新的Task（如打开新应用）或者点击Home键回到桌面时，任务栈退到后台；当位于后台时，Task中的Activity都会进入停止状态。退到后台的Task的返回栈仍然保持完整性。如：Task A的栈中有三个Activity，用户点击Home键，打开新的应用程序，Task A退到后台。新的应用程序启动，系统创建并启动新的Task B。用户再次回到桌面，打开Task A对应的应用程序，Task A回到前台，Task A中的三个Activity保持完整性。</li>
<li>Android支持后台多任务；但同时运行多个后台任务，系统可能销毁后台的Activity来回收内存，就导致后台Activity的状态丢失。</li>
</ul>
<h2 id="1-Activity任务管理。"><a href="#1-Activity任务管理。" class="headerlink" title="1. Activity任务管理。"></a>1. Activity任务管理。</h2><p>默认情况下Android中的Activity通过<code>standard</code>启动模式进入在后进先出的Stack（返回栈）中。有时因为业务需求，需要修改Activity的默认启动模式。如：在新的任务中来启动Activity而不是在返回栈的栈顶创建新的实例；又比如：在启动Activity时，只想要启动Activity已存在的实例；或在用户离开任务时清空除了根Activity外所有的Activity。</p>
<p>修改Activity的默认启动模式有两种方法：</p>
<ol>
<li>在AndroidManifest中指定Activity的任务和启动模式。</li>
<li>在启动Activity的Intent中加入标志位。</li>
</ol>
<p>在优先级上第二种高于第一种，就是在Intent中传递Flag标志的方式会覆盖在XML指定启动模式的方式。<br>标准启动模式，启动Activity时，系统会创建Activity新的实例。Activity可能会多次创建：每个实例可能属于不同任务，一个任务可能有多个实例。</p>
<h3 id="1）AndroidManifest中指定Activity的任务和启动模式。"><a href="#1）AndroidManifest中指定Activity的任务和启动模式。" class="headerlink" title="1）AndroidManifest中指定Activity的任务和启动模式。"></a>1）AndroidManifest中指定Activity的任务和启动模式。</h3><figure class="highlight xml"><figcaption><span>AndroidManefest.xml</span></figcaption><table><tr><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">activity</span></span></div><div class="line">    <span class="attr">android:name</span>=<span class="string">".activity.MainActivity"</span></div><div class="line">    <span class="attr">android:taskAffinity</span>=<span class="string">"string"</span></div><div class="line">    <span class="attr">android:launchMode</span>=<span class="string">[</span>"<span class="attr">multiple</span>" | "<span class="attr">singleTop</span>" |</div><div class="line">                  "<span class="attr">singleTask</span>" | "<span class="attr">singleInstance</span>"]</div><div class="line">    <span class="attr">android:clearTaskOnLaunch</span>=<span class="string">[</span>"<span class="attr">true</span>" | "<span class="attr">false</span>"]</div><div class="line">    <span class="attr">android:alwaysRetainTaskState</span>=<span class="string">[</span>"<span class="attr">true</span>" | "<span class="attr">false</span>"]</div><div class="line">    <span class="attr">android:finishOnTaskLaunch</span>=<span class="string">[</span>"<span class="attr">true</span>" | "<span class="attr">false</span>"] </div><div class="line">    <span class="attr">...</span> &gt;</div><div class="line">    ...</div><div class="line"><span class="tag">&lt;/<span class="name">activity</span>&gt;</span></div><div class="line"></div></pre></td></tr></table></figure>
<ul>
<li><p><code>taskAffinity</code><br>taskAffinity表示Activity对应的任务。有相同taskAffinity的Activity理论属于同一个任务。任务自身的Affinity决定<br>根Activity的Affinity值。taskAffinity的使用场合是什么呢？1.根据taskAffinity重新为Activity选择任务（与<br>allowTaskReparenting属性配合工作）；2.启动Activity时，Intent使用FLAG_ACTIVITY_NEW_TASK标记，根据<br>taskAffinity查找或创建一个新Activity对应taskAffinity的任务。默认情况下，应用内所有Activity都具有相同的<br>taskAffinity,都是从Application继承来，而Application默认taskAffinity值为<manifest>中定义的包名。</manifest></p>
</li>
<li><p><code>launchMode</code><br>launchMode表示Activity启动模式。配合Intent的Activity Flags使用。</p>
</li>
<li><p><code>allowTaskReparenting</code><br>Activity是否从启动它的任务中移动到目标任务中，”true”表示可以移动；”false”表示必须保留在启动它的任务中。<br>如果没有设置，则继承<application>中的属性值，默认false。正常情况下Activity位于启动它的任务中，并度过它的整个生命周期。</application></p>
</li>
<li><p><code>clearTaskOnLaunch</code><br>标记是否从任务中清除除根Activity的所有Activity，”true”表示清除，”false”表示不清除。默认”false”。这个属性只对根Activity起作用。如果为”true”，每次重新启动应用时，都只看到根Activity，任务中的其他的Activity都会被清除栈。</p>
</li>
<li><p><code>alwaysRetainTaskState</code><br>标记任务是否保持原来的状态，”true”总是保持，”false”不能保证，默认”false”。属性只对根Activity起作用。默认情况下，如果应用在后台停留过长时间，应用再次回到前台时，系统会对应用任务的栈进行清空处理。只保留根Activity。如果根Activity的这个属性为”true”时，应用回到前台时，任务仍然保留所有的Activity。如：浏览器应用打开很多tab页面，在后台停留过长时间，回到前台时，仍然保留这些打开的界面。</p>
</li>
<li><p><code>finishOnTaskLaunch</code><br>finishOnTaskLaunch属性与clearTaskOnLaunch属性类似，不同是它是在操作单个的Activity，而不是整个任务栈。它可以销毁任意Activity包括根Activity。当设置为”true”时，如果用户离开然后回到任务栈，则Activity不再显示。</p>
</li>
</ul>
<blockquote>
<p>注：多数任务和Activity启动模式应该保持默认值。除非必要情况下，需要改变默认行为。</p>
</blockquote>
<h2 id="2-启动模式"><a href="#2-启动模式" class="headerlink" title="2. 启动模式"></a>2. 启动模式</h2><p>Activity有四种启动模式：<code>standard</code>，<code>singleTop</code>，<code>singleTask</code>和<code>singleInstance</code></p>
<ul>
<li><code>standard</code><br>Activity的默认启动模式，不论栈中是否已存在Activity的实例，都会在创建新的Activity实例，放入栈顶。如下图ActivityA和ActivityB均为standard启动模式。</li>
</ul>
<div><br>    <image src="http://res.cloudinary.com/dmfz9aun7/image/upload/v1467702956/android/android_launchmode_standard.png" style="width:60%;"><br></image></div>

<ul>
<li><code>singleTop</code><br>任务栈顶存在要启动的Activity，系统不会创建新的Activity实例，只调用Activity的onNewIntent()方法。Activity可能被多次实例化，每个Activity实例可能属于不同任务栈，一个任务栈可能有多个实例（仅在返回栈栈顶的Activity不是启动的Activity实例情况下）<br>假设有任务的返回栈包含ABCD的Activity，A为根Activity，D在栈顶；如果启动D并且D启动模式为”singleTop”，则调用栈顶已经存在的D的方法onNewIntent()，栈内容不变，仍为”ABCD”；如果启动B，B的启动模式为”singleTop”，则会创建新的B实例，并压人栈中。如下图ActivityA和ActivityB均为singleTop启动模式。</li>
</ul>
<div><br>    <image src="http://res.cloudinary.com/dmfz9aun7/image/upload/v1467702956/android/android_launchmode_singleTop.png" style="width:60%;"><br></image></div><br>&gt; 注：当创建新的Activity，用户点击返回键会返回之前Activity。如果已存在的Activity来处理一个新的Intent对象时，在Intent进入onNewIntent()之前，用户点击返回键无法返回Activity之前的状态。<br><br>- <code>singleTask</code><br>系统查找或创建新Activity对应的任务，已有任务栈时直接向栈中添加Activity的实例；否则创建新的Activity实例作为新任务栈的根。如果指定的任务栈中已经存在Activity的实例，系统只调用Acitivity的onNewIntent()方法，而不是创建新的Activity，同时只能够存在一个相同Activity实例。需要配合<code>android:taskAffinity</code>属性来使用。若taskAffinity的值与应用程序一致，新的Activity仍然会在应用程序的默认任务栈中。<br><br><div><br><image src="http://res.cloudinary.com/dmfz9aun7/image/upload/v1467552922/android/diagram_backstack_singletask_multiactivity.png" style="width:60%;"><br></image></div>

<blockquote>
<p>注：尽管”singleTask”启动了一个新任务，点击返回键时仍然返回到之前的Activity对应的任务栈。</p>
</blockquote>
<ul>
<li><code>singleInstance</code><br>除了具有”singleTask”的全部特性以外，系统不会在有”singleInstance”启动模式的Activity对应栈中启动任何其他的Activity。具有”singleInstance”启动模式的Activity是栈中唯一的成员，通过这个任务栈启动的Activity都会在指定的任务栈中打开。</li>
</ul>
<div><br><image src="http://res.cloudinary.com/dmfz9aun7/image/upload/v1467705412/android/android_launchmode_singleInstance.png" style="width:70%"><br></image></div>

<p>不管在新的任务中启动Activity还是在启动时的任务栈中启动Activity，点击返回键总是回到之前的Activity。如果你指定Activity的启动模式为singleTask，并在后台任务栈中存在对应的实例。启动这个Acitivity时，就会把整个任务栈带到前台。这时候，返回栈包含所有带到前台的任务栈中所有Activity，并置于栈顶。如singleTask小节图示。</p>
<figure class="highlight"><table><tr><td class="code"><pre><div class="line">/**</div><div class="line">* 假设有三个Activity：MainAcitivity，ActivityA，ActivityB。MainActivity为应用程序的入口Activity，ActivityA是</div><div class="line">* `singleTask`启动模式，任务为`org.alexwan.taskandflag`的Activity，ActivityB与ActivityA一样。在启动MainActivity</div><div class="line">* 后，由MainActivity启动ActivityA，ActivityA启动ActivityB。</div><div class="line">*/</div><div class="line"></div><div class="line">// 查看运行栈 命令</div><div class="line">adb shell dumpsys activity activities | sed -En -e '/Running activities/,/Run #0/p'</div><div class="line"></div><div class="line">// 结果</div><div class="line">Running activities (most recent first):</div><div class="line">    TaskRecord&#123;d42fd8e #7592 A=org.alexwan.view U=0 sz=2&#125;</div><div class="line">        Run #2: ActivityRecord&#123;247d0678 u0 org.alexwan.taskandflag/.ActivityB t7592&#125;</div><div class="line">        Run #1: ActivityRecord&#123;168061c4 u0 org.alexwan.taskandflag/.ActivityA t7592&#125;</div><div class="line">    TaskRecord&#123;20b981bc #7591 A=org.alexwan.taskandflag U=0 sz=1&#125;</div><div class="line">        Run #0: ActivityRecord&#123;618def7 u0 org.alexwan.taskandflag/.MainActivity t7591&#125;</div></pre></td></tr></table></figure>
<h2 id="3-Intent-Activity标志"><a href="#3-Intent-Activity标志" class="headerlink" title="3.Intent Activity标志"></a>3.Intent Activity标志</h2><p>在调用startActivity时，为Intent添加一个标志位决定Activity启动方式。用来修改默认行为.<br><figure class="highlight java"><figcaption><span>Intent.java</span></figcaption><table><tr><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">// 用新任务启动Activity。如果任务中的Activity已运行需要启动的Activity，则直接返回前台状态并调用onNewIntent()方</span></div><div class="line"><span class="comment">// 法。与"singleTask"效果相同</span></div><div class="line">FLAG_ACTIVITY_NEW_TASK</div><div class="line"></div><div class="line"><span class="comment">// 如果启动的Activity在返回栈栈顶，则直接调用Activity的onNewIntent方法，而不是创建一个新的实例。</span></div><div class="line"><span class="comment">// 与"singleTop"效果相同。</span></div><div class="line">FLAG_ACTIVITY_SINGLE_TOP</div><div class="line"></div><div class="line"><span class="comment">// 如果启动的Activity已经运行在当前任务栈中，则它的所有顶部Activity都会被销毁，而不是创建一个新Activity实例。调用</span></div><div class="line"><span class="comment">// onNewIntent()方法恢复Activity状态。</span></div><div class="line">FLAG_ACTIVITY_CLEAR_TOP</div><div class="line"></div><div class="line"><span class="comment">// 启动的Activity不会出现在历史Activity的列表中，在某些情况下我们不希望用户通过历史列表回到Activity时会使用这个标</span></div><div class="line"><span class="comment">// 志。与在AndroidManifest中指定Activity的android:excludeFromRecents="true"属性效果相同。</span></div><div class="line">FLAG_ACTIVITY_EXCLUDE_FROM_RECENTS</div><div class="line"></div></pre></td></tr></table></figure></p>
<blockquote>
<p><code>FLAG_ACTIVITY_CLEAR_TOP</code>常和<code>FLAG_ACTIVITY_NEW_TASK</code>配合使用。当同时使用，这些标志是定位其他栈中存在的Activity和放置在可以享用Intent的位置的方式。这种情况下，被启动Activity的实例如果已经存在，那么系统就会调用它的onNewIntent()方法。如果被启动的Activity采用”standard”启动模式，那么它连同它之上的Activity都要出栈，系统会创建新的Activity实例并置于栈顶。 </p>
</blockquote>
<h2 id="4-处理affinities"><a href="#4-处理affinities" class="headerlink" title="4. 处理affinities"></a>4. 处理affinities</h2><p>affinity 表示Activity对应的任务栈值。默认情况下所有Activity继承Application对应的包名所在的任务栈。可以在AndroidManifest中为Activity修改默认affinity值。不同Application可以共享相同affinity属性，同样相同Application中的Activity可以关联不同的affinity属性。<br>如：<br><figure class="highlight xml"><table><tr><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">activity</span></span></div><div class="line">    <span class="attr">android:name</span>=<span class="string">".ActivityB"</span></div><div class="line">    <span class="attr">android:launchMode</span>=<span class="string">"singleTask"</span></div><div class="line">    <span class="attr">android:taskAffinity</span>=<span class="string">"org.alexwan.view"</span> /&gt;</div></pre></td></tr></table></figure></p>
<p>TaskAffinitys主要配合”singleTask”启动模式和”allowTaskReparenting”属性来使用</p>
<ul>
<li><p>1）配合”singleTask”启动模式的Activity使用的情景；如通知管理总是在外部的任务栈中启动Activity，而不是作为Application任务栈的一部分。所以通知类的Intent总是用FLAG_ACTIVITY_NEW_TASK在intent的属性中传递给startActivity()。</p>
</li>
<li><p>2）配合 allowTaskReparenting 属性使用情景。假设Activity的allowTaskReparenting的值为”true”，这种情况下，在Activity对应的任务栈回到前台，并且已经被其他任务栈启动时，则会从其他任务栈转到Activity对应的任务栈中。比如：在应用程序A中打开浏览器的Activity，Activity初始化时属于应用A的对应的任务栈，当浏览器回到前台时，Activity则从应用A任务栈转到浏览器的任务栈直接显示。</p>
</li>
</ul>
<h1 id="三、Activity的启动匹配规则"><a href="#三、Activity的启动匹配规则" class="headerlink" title="三、Activity的启动匹配规则"></a>三、Activity的启动匹配规则</h1><p>Intent打开Activity时分为隐式、显式打开Actiivty。</p>
<p><code>显式启动</code>：这种情况启动的Activity为已知，显式Intent也是启动Activity最常用的方式。<br><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">Intent intent = <span class="keyword">new</span> Intent(ActivityA.<span class="keyword">this</span> , ActivityB.class);</div><div class="line">startActivity(intent);</div></pre></td></tr></table></figure></p>
<p><code>隐式启动</code>：在未知启动的Activity的情况时，通过action，data，category等IntentFilter属性来过滤匹配要启动的Activity，Activity可能为多个或者没有对应Activity。如：启动分享、打开多媒体相关的Activity等。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">Intent sendIntent = <span class="keyword">new</span> Intent();</div><div class="line">sendIntent.setAction(Intent.ACTION_VIEW);</div><div class="line">sendIntent.putExtra(Intent.EXTRA_TEXT , message);</div><div class="line">sendIntent.setType(<span class="string">"text/plain"</span>);</div><div class="line"><span class="keyword">if</span>(sendIntent.resolveActivity(getPackageManager()) != <span class="keyword">null</span>)&#123;</div><div class="line">    startActivity(sendIntent);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>注：如果没有匹配到相应的Activity时，调用startActivity()时，应用程序直接崩溃。因此在使用隐式Intent时，需要调用resolveActivity()来判断是否有相匹配的Activity来接收Intent，如果没有则不会调用startActivity。</p>
</blockquote>
<h2 id="1-IntentFilter匹配规则。"><a href="#1-IntentFilter匹配规则。" class="headerlink" title="1. IntentFilter匹配规则。"></a>1. IntentFilter匹配规则。</h2><figure class="highlight xml"><table><tr><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">activity</span> </span></div><div class="line">    <span class="attr">android:name</span>=<span class="string">".activity.ActivityA"</span></div><div class="line">    <span class="attr">...</span>&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"android.intent.action.VIEW"</span>&gt;</span></div><div class="line">        ...</div><div class="line">        <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">"android.intent.category.DEFAULT"</span>/&gt;</span></div><div class="line">        ...</div><div class="line">        <span class="tag">&lt;<span class="name">data</span> <span class="attr">android:scheme</span>=<span class="string">"package"</span> /&gt;</span></div><div class="line">        ...</div><div class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">activity</span>&gt;</span></div></pre></td></tr></table></figure>
<p>只在有action、category、data都匹配时，Intent才算是匹配成功，如果Activity若声明多个IntentFilter时，只需匹配任意一个则表示匹配成功。</p>
<p>（1） action<br>一个Intent Filter中可声明0个或多个action，Intent中的action与其中任一action在字符串形式上完全相同（区分大小写），action就算是匹配成功。Intent调用setAction或构造器中传入action为Intent设置action。隐式Intent必须指定action。</p>
<p>（2）category<br>与action相同，一个Intent Filter可声明多个category或不声明category属性。Intent中的category必须全部匹配Filter中出现的category。Intent若没有指定category，同样能够匹配成功，因为Intent没有指定category时，Android自定为Intent指定默认category值<code>Intent.CATEGORY_DEFAULT</code><br><figure class="highlight xml"><table><tr><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">"android.intent.category.DEFAULT"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">"android.intent.category.BROWSABLE"</span> /&gt;</span></div><div class="line">    ...</div><div class="line"><span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>（3）data<br>与action相同，一个Intent Filter可声明多个data或不声明data属性。<br><figure class="highlight xml"><table><tr><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">data</span> <span class="attr">android:mimeType</span>=<span class="string">"video/mpeg"</span> <span class="attr">android:scheme</span>=<span class="string">"http"</span> <span class="attr">...</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">data</span> <span class="attr">android:mimeType</span>=<span class="string">"audio/mpeg"</span> <span class="attr">android:scheme</span>=<span class="string">"http"</span> <span class="attr">...</span> /&gt;</span></div><div class="line">    ...</div><div class="line"><span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>每个<data>可以指定一个URI和一个数据类型（MIME 媒体类型）。</data></p>
<p><code>URI</code><br>结构：<code>&lt;scheme&gt;://&lt;host&gt;:&lt;port&gt;/&lt;path&gt;</code>。如：”content://com.example.project:200/folder/subfolder/etc”。</p>
<blockquote>
<p>注：如果scheme没有指定，则忽略host；host没有指定，则忽略port；如果scheme和host都没有指定，则忽略path。path可以包含星号（*）通配符部分满足path的名称。<br>URI默认值为content和file。如果filter中没有指定URI，Intent中的URI部分的scheme必须为content或file才能匹配。如果为Intent指定完整的data，必须调用setDataAndType()，单独的调用setData或setType()会重置Data和Type属性。</p>
</blockquote>
<h1 id="四、Activity的启动过程"><a href="#四、Activity的启动过程" class="headerlink" title="四、Activity的启动过程"></a>四、Activity的启动过程</h1><div><br><image src="http://res.cloudinary.com/dmfz9aun7/image/upload/v1467896657/android/%E5%90%AF%E5%8A%A8%E5%BA%94%E7%94%A8%E6%97%B6%E7%9A%84Activity%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B.png" style="width:100%"><br><div style="text-align:center;"><b>4-1. Android 5.0的启动应用程序时Activity的时序图</b></div><br></image></div>

<p>应用程序的入口MainActivity的定义</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">".MainActivity"</span>    </span></div><div class="line">      <span class="attr">android:label</span>=<span class="string">"@string/app_name"</span>&gt;    </div><div class="line">       <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span>    </div><div class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"android.intent.action.MAIN"</span> /&gt;</span>    </div><div class="line">        <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">"android.intent.category.LAUNCHER"</span> /&gt;</span>    </div><div class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span>    </div><div class="line"><span class="tag">&lt;/<span class="name">activity</span>&gt;</span></div></pre></td></tr></table></figure>
<p>Android中启动应用程序从桌面启动，系统桌面实际上也是应用程序，对应的是Launcher。</p>
<figure class="highlight java"><figcaption><span>com.android.launcher2.Launcher.java</span></figcaption><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">startActivitySafely</span><span class="params">(View v, Intent intent, Object tag)</span> </span>&#123;</div><div class="line">    <span class="keyword">boolean</span> success = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">// 调用Activity的startActivity方法。</span></div><div class="line">        success = startActivity(v, intent, tag);</div><div class="line">    &#125; <span class="keyword">catch</span> (ActivityNotFoundException e) &#123;</div><div class="line">        Toast.makeText(<span class="keyword">this</span>, R.string.activity_not_found, Toast.LENGTH_SHORT).show();</div><div class="line">        Log.e(TAG, <span class="string">"Unable to launch. tag="</span> + tag + <span class="string">" intent="</span> + intent, e);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> success;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>调用Activity的startActivity方法，最终调用Activity的startActivityForResult方法。<br><figure class="highlight java"><figcaption><span>Activity.java</span></figcaption><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivity</span><span class="params">(Intent intent, @Nullable Bundle options)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (options != <span class="keyword">null</span>) &#123;</div><div class="line">        startActivityForResult(intent, -<span class="number">1</span>, options);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// Note we want to go through this call for compatibility with</span></div><div class="line">        <span class="comment">// applications that may have overridden the method.</span></div><div class="line">        startActivityForResult(intent, -<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivityForResult</span><span class="params">(</span></span></div><div class="line">        String who, Intent intent, <span class="keyword">int</span> requestCode, @Nullable Bundle options) &#123;</div><div class="line">    ...</div><div class="line">    <span class="comment">// 1. 创建要启动的Activity实例信息。</span></div><div class="line">    Instrumentation.ActivityResult ar =</div><div class="line">        mInstrumentation.execStartActivity(</div><div class="line">            <span class="keyword">this</span>, mMainThread.getApplicationThread(), mToken, who,</div><div class="line">            intent, requestCode, options);</div><div class="line">    <span class="keyword">if</span> (ar != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// mMainThread 就是ActivityThread</span></div><div class="line">        mMainThread.sendActivityResult(</div><div class="line">            mToken, who, requestCode,</div><div class="line">            ar.getResultCode(), ar.getResultData());</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>Instrumentation</code>主要用来监控应用程序的交互操作。只在Activity和ActivityThread有实例，每次在应用程序创建的时候，在ActivityThread中初始化唯一的实例<code>mInstrumentation</code>，后续在每个Activity.attach方法中，添加到Activity的中。这里调用execStartActivity执行Activity的启动流程。</p>
<figure class="highlight java"><figcaption><span>Instrumentation.java</span></figcaption><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> ActivityResult <span class="title">execStartActivity</span><span class="params">(</span></span></div><div class="line">        Context who, IBinder contextThread, IBinder token, Activity target,</div><div class="line">        Intent intent, <span class="keyword">int</span> requestCode, Bundle options, UserHandle user) &#123;</div><div class="line">    <span class="comment">// contextThread 是IBinder对象，主要用来与底层进程之间交互。</span></div><div class="line">    <span class="comment">// whoThread 是Launcher的IApplicationThread</span></div><div class="line">    IApplicationThread whoThread = (IApplicationThread) contextThread;</div><div class="line">    ...</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        intent.migrateExtraStreamToClipData();</div><div class="line">        intent.prepareToLeaveProcess();</div><div class="line">        <span class="comment">// 获取到ActivityManagerService远程接口即ActivityManagerProxy，调用</span></div><div class="line">        <span class="comment">// startActivityAsUser的方法</span></div><div class="line">        <span class="keyword">int</span> result = ActivityManagerNative.getDefault()</div><div class="line">            .startActivityAsUser(whoThread, who.getBasePackageName(), intent,</div><div class="line">                    intent.resolveTypeIfNeeded(who.getContentResolver()),</div><div class="line">                    token, target != <span class="keyword">null</span> ? target.mEmbeddedID : <span class="keyword">null</span>,</div><div class="line">                    requestCode, <span class="number">0</span>, <span class="keyword">null</span>, options, user.getIdentifier());</div><div class="line">        <span class="comment">// 根据返回结果，检测是否成功启动Activity，如果没有抛出异常</span></div><div class="line">        checkStartActivityResult(result, intent);</div><div class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Failure from system"</span>, e);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Instrumentation的execStartActivity方法中获得Launcher的IApplicationThread，主要用它与ActivityThread进行进程间通信。获取到ActivityManagerService的远程接口ActivityManagerProxy，调用startActivityAsUser方法。<br>ActivityManagerProxy定义在ActivityManagerNative中<br><figure class="highlight java"><figcaption><span>ActivityManagerNative.java -> ActivityManagerProxy.java</span></figcaption><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityManagerNative</span> <span class="keyword">extends</span> <span class="title">Binder</span> <span class="keyword">implements</span> <span class="title">IActivityManager</span></span></div><div class="line">&#123;</div><div class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">public</span> IActivityManager <span class="title">asInterface</span><span class="params">(IBinder obj)</span> </span>&#123;</div><div class="line">        ...</div><div class="line">        <span class="comment">// 创建ActivityManagerProxy实例</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ActivityManagerProxy(obj);</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">public</span> IActivityManager <span class="title">getDefault</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// 单例模式获取到IActivityManager，如果IActivityManager未创建</span></div><div class="line">        <span class="comment">// 则调用create方法创建IActivityManager</span></div><div class="line">        <span class="keyword">return</span> gDefault.get();</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Singleton&lt;IActivityManager&gt; gDefault = <span class="keyword">new</span> Singleton&lt;IActivityManager&gt;() &#123;</div><div class="line">        <span class="function"><span class="keyword">protected</span> IActivityManager <span class="title">create</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="comment">// 查找ActivityManagerService</span></div><div class="line">            IBinder b = ServiceManager.getService(<span class="string">"activity"</span>);</div><div class="line">            <span class="comment">// am 就是ActivityManagerProxy</span></div><div class="line">            IActivityManager am = asInterface(b);</div><div class="line">            </div><div class="line">            <span class="keyword">return</span> am;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ActivityManagerProxy</span> <span class="keyword">implements</span> <span class="title">IActivityManager</span></span></div><div class="line">&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ActivityManagerProxy</span><span class="params">(IBinder remote)</span></span></div><div class="line">    &#123;</div><div class="line">        mRemote = remote;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">asBinder</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> mRemote;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div><div class="line"></div></pre></td></tr></table></figure></p>
<p>调用ActivityManagerProxy的startActivityAsUser方法，通过Binder驱动调用ActivityManagerService的startActivity<br>```java </p>
<figure class="highlight java"><figcaption><span>ActivityManagerProxy.java</span></figcaption><table><tr><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(IApplicationThread caller, String callingPackage, Intent intent,</span></span></div><div class="line">        String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</div><div class="line">        <span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle options) <span class="keyword">throws</span> RemoteException &#123;</div><div class="line">...</div><div class="line"><span class="comment">// mRemote 是个Binder，ServiceManager.getService("activity")返回的binder对象</span></div><div class="line">mRemote.transact(START_ACTIVITY_TRANSACTION, data, reply, <span class="number">0</span>);</div><div class="line">...</div><div class="line"><span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>调用ActivityManagerNative的onTransact方法。<br><figure class="highlight java"><figcaption><span>ActivityManagerNative.java</span></figcaption><table><tr><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTransact</span><span class="params">(<span class="keyword">int</span> code, Parcel data, Parcel reply, <span class="keyword">int</span> flags)</span></span></div><div class="line">        <span class="keyword">throws</span> RemoteException &#123;</div><div class="line">    <span class="keyword">switch</span> (code) &#123;</div><div class="line">    <span class="keyword">case</span> START_ACTIVITY_TRANSACTION:</div><div class="line">    &#123;</div><div class="line">        ...</div><div class="line">        IBinder b = data.readStrongBinder();</div><div class="line">        <span class="comment">// ApplicationThreadProxy</span></div><div class="line">        IApplicationThread app = ApplicationThreadNative.asInterface(b);</div><div class="line">        ...</div><div class="line">        Intent intent = Intent.CREATOR.createFromParcel(data);</div><div class="line">        ...</div><div class="line">        <span class="comment">// resultTo</span></div><div class="line">        IBinder resultTo = data.readStrongBinder();</div><div class="line">        ...</div><div class="line">        <span class="comment">// ActivityManagerService是ActivityManagerNative的具体实现</span></div><div class="line">        <span class="comment">// startActivity也是由ActivityManagerService来执行。</span></div><div class="line">        <span class="keyword">int</span> result = startActivity(app, callingPackage, intent, resolvedType,</div><div class="line">                resultTo, resultWho, requestCode, startFlags, profilerInfo, options);</div><div class="line">        ...</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure><br>最终由ActivityManagerService实现调用startActivity<br><figure class="highlight java"><figcaption><span>ActivityManagerService.java</span></figcaption><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(IApplicationThread caller, String callingPackage,</span></span></div><div class="line">        Intent intent, String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</div><div class="line">        <span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle options) &#123;</div><div class="line">    <span class="comment">// 调用startActivityAsUser</span></div><div class="line">    <span class="keyword">return</span> startActivityAsUser(caller, callingPackage, intent, resolvedType, resultTo,</div><div class="line">        resultWho, requestCode, startFlags, profilerInfo, options,</div><div class="line">        UserHandle.getCallingUserId());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityAsUser</span><span class="params">(IApplicationThread caller, String callingPackage,</span></span></div><div class="line">        Intent intent, String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</div><div class="line">        <span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle options, <span class="keyword">int</span> userId) &#123;</div><div class="line">    ...</div><div class="line">    <span class="comment">//  调用ActivityStackSupervisor的startActivityMayWait</span></div><div class="line">    <span class="keyword">return</span> mStackSupervisor.startActivityMayWait(caller, -<span class="number">1</span>, callingPackage, intent,</div><div class="line">            resolvedType, <span class="keyword">null</span>, <span class="keyword">null</span>, resultTo, resultWho, requestCode, startFlags,</div><div class="line">            profilerInfo, <span class="keyword">null</span>, <span class="keyword">null</span>, options, <span class="keyword">false</span>, userId, <span class="keyword">null</span>, <span class="keyword">null</span>);</div><div class="line">&#125;</div><div class="line"></div></pre></td></tr></table></figure></p>
<p><code>ActivityStackSupervisor</code>startActivityMayWait</p>
<figure class="highlight java"><figcaption><span>ActivityStackSupervisor.java</span></figcaption><table><tr><td class="code"><pre><div class="line"> <span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityMayWait</span><span class="params">(IApplicationThread caller, <span class="keyword">int</span> callingUid,</span></span></div><div class="line">         String callingPackage, Intent intent, String resolvedType,</div><div class="line">         IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</div><div class="line">         IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode, <span class="keyword">int</span> startFlags,</div><div class="line">         ProfilerInfo profilerInfo, WaitResult outResult, Configuration config,</div><div class="line">         Bundle options, <span class="keyword">boolean</span> ignoreTargetSecurity, <span class="keyword">int</span> userId,</div><div class="line">         IActivityContainer iContainer, TaskRecord inTask) &#123;</div><div class="line">     ...</div><div class="line">     <span class="comment">// Collect information about the target of the Intent.</span></div><div class="line">    <span class="comment">// 收集MainActivity信息</span></div><div class="line">     ActivityInfo aInfo = resolveActivity(intent, resolvedType, startFlags, profilerInfo, userId);</div><div class="line">     ...</div><div class="line">     <span class="keyword">synchronized</span> (mService) &#123;</div><div class="line">         ...</div><div class="line">         <span class="keyword">final</span> ActivityStack stack;</div><div class="line">         <span class="keyword">if</span> (container == <span class="keyword">null</span> || container.mStack.isOnHomeDisplay()) &#123;</div><div class="line">             stack = mFocusedStack;</div><div class="line">         &#125; <span class="keyword">else</span> &#123;</div><div class="line">             stack = container.mStack;</div><div class="line">         &#125;</div><div class="line">         ...</div><div class="line">         <span class="keyword">int</span> res = startActivityLocked(caller, intent, resolvedType, aInfo,</div><div class="line">                 voiceSession, voiceInteractor, resultTo, resultWho,</div><div class="line">                 requestCode, callingPid, callingUid, callingPackage,</div><div class="line">                 realCallingPid, realCallingUid, startFlags, options, ignoreTargetSecurity,</div><div class="line">                 componentSpecified, <span class="keyword">null</span>, container, inTask);</div><div class="line">         ...</div><div class="line">         <span class="keyword">return</span> res;</div><div class="line">     &#125;</div><div class="line"> &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityLocked</span><span class="params">(IApplicationThread caller,</span></span></div><div class="line">         Intent intent, String resolvedType, ActivityInfo aInfo,</div><div class="line">         IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</div><div class="line">         IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</div><div class="line">         <span class="keyword">int</span> callingPid, <span class="keyword">int</span> callingUid, String callingPackage,</div><div class="line">         <span class="keyword">int</span> realCallingPid, <span class="keyword">int</span> realCallingUid, <span class="keyword">int</span> startFlags, Bundle options,</div><div class="line">         <span class="keyword">boolean</span> ignoreTargetSecurity, <span class="keyword">boolean</span> componentSpecified, ActivityRecord[] outActivity,</div><div class="line">         ActivityContainer container, TaskRecord inTask) &#123;</div><div class="line">     <span class="keyword">int</span> err = ActivityManager.START_SUCCESS;</div><div class="line">     <span class="comment">// 指定进程的所有信息</span></div><div class="line">     ProcessRecord callerApp = <span class="keyword">null</span>;        </div><div class="line">     <span class="keyword">if</span> (caller != <span class="keyword">null</span>) &#123;</div><div class="line">         callerApp = mService.getRecordForAppLocked(caller);</div><div class="line">         <span class="keyword">if</span> (callerApp != <span class="keyword">null</span>) &#123;</div><div class="line">             callingPid = callerApp.pid;</div><div class="line">             callingUid = callerApp.info.uid;</div><div class="line">         &#125; <span class="keyword">else</span> &#123;</div><div class="line">             ...</div><div class="line">         &#125;</div><div class="line">     &#125;</div><div class="line">     ...</div><div class="line"></div><div class="line">     <span class="keyword">final</span> <span class="keyword">int</span> userId = aInfo != <span class="keyword">null</span> ? UserHandle.getUserId(aInfo.applicationInfo.uid) : <span class="number">0</span>;</div><div class="line">     <span class="comment">// 历史栈中的实体，表示一个Activity</span></div><div class="line">     ActivityRecord sourceRecord = <span class="keyword">null</span>;</div><div class="line">     ActivityRecord resultRecord = <span class="keyword">null</span>;</div><div class="line">     ... </div><div class="line">     <span class="comment">// 启动标志位</span></div><div class="line">     <span class="keyword">final</span> <span class="keyword">int</span> launchFlags = intent.getFlags();</div><div class="line">     ...</div><div class="line">     <span class="keyword">final</span> ActivityStack resultStack = resultRecord == <span class="keyword">null</span> ? <span class="keyword">null</span> : resultRecord.task.stack;</div><div class="line">     ...</div><div class="line">     <span class="keyword">boolean</span> abort = <span class="keyword">false</span>;</div><div class="line">     ...</div><div class="line">     abort |= !mService.mIntentFirewall.checkStartActivity(intent, callingUid,</div><div class="line">             callingPid, resolvedType, aInfo.applicationInfo);</div><div class="line">     ...</div><div class="line">     <span class="keyword">if</span> (abort) &#123;</div><div class="line">         <span class="keyword">if</span> (resultRecord != <span class="keyword">null</span>) &#123;</div><div class="line">             resultStack.sendActivityResultLocked(-<span class="number">1</span>, resultRecord, resultWho, requestCode,</div><div class="line">                     Activity.RESULT_CANCELED, <span class="keyword">null</span>);</div><div class="line">         &#125;</div><div class="line">         <span class="comment">// We pretend to the caller that it was really started, but</span></div><div class="line">         <span class="comment">// they will just get a cancel result.</span></div><div class="line">         ActivityOptions.abort(options);</div><div class="line">         <span class="keyword">return</span> ActivityManager.START_SUCCESS;</div><div class="line">     &#125;</div><div class="line">     ActivityRecord r = <span class="keyword">new</span> ActivityRecord(mService, callerApp, callingUid, callingPackage,</div><div class="line">             intent, resolvedType, aInfo, mService.mConfiguration, resultRecord, resultWho,</div><div class="line">             requestCode, componentSpecified, voiceSession != <span class="keyword">null</span>, <span class="keyword">this</span>, container, options);</div><div class="line">     ...</div><div class="line">     err = startActivityUncheckedLocked(r, sourceRecord, voiceSession, voiceInteractor,</div><div class="line">             startFlags, <span class="keyword">true</span>, options, inTask);</div><div class="line"></div><div class="line">     <span class="keyword">return</span> err;</div><div class="line"> &#125;</div><div class="line"></div><div class="line"><span class="comment">// startActivityUncheckedLocked</span></div><div class="line"></div><div class="line"> <span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityUncheckedLocked</span><span class="params">(<span class="keyword">final</span> ActivityRecord r, ActivityRecord sourceRecord,</span></span></div><div class="line">         IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor, <span class="keyword">int</span> startFlags,</div><div class="line">         <span class="keyword">boolean</span> doResume, Bundle options, TaskRecord inTask) &#123;</div><div class="line">     <span class="keyword">final</span> Intent intent = r.intent;</div><div class="line">     <span class="keyword">final</span> <span class="keyword">int</span> callingUid = r.launchedFromUid;</div><div class="line">     ...</div><div class="line">     <span class="keyword">final</span> <span class="keyword">boolean</span> launchSingleTop = r.launchMode == ActivityInfo.LAUNCH_SINGLE_TOP;</div><div class="line">     <span class="keyword">final</span> <span class="keyword">boolean</span> launchSingleInstance = r.launchMode == ActivityInfo.LAUNCH_SINGLE_INSTANCE;</div><div class="line">     <span class="keyword">final</span> <span class="keyword">boolean</span> launchSingleTask = r.launchMode == ActivityInfo.LAUNCH_SINGLE_TASK;</div><div class="line">     <span class="comment">// </span></div><div class="line">     <span class="keyword">int</span> launchFlags = intent.getFlags();</div><div class="line">     ...</div><div class="line">     <span class="comment">// 如果启动的Activity没有指明是自启动，则在onPause之前调用onUserLeaving</span></div><div class="line">     <span class="comment">// launchFlags的FLAG_ACTIVITY_NO_USER_ACTION初始值为0，所以mUserLeaving为true</span></div><div class="line">     mUserLeaving = (launchFlags &amp; Intent.FLAG_ACTIVITY_NO_USER_ACTION) == <span class="number">0</span>;</div><div class="line">     ...</div><div class="line">     <span class="comment">// 与FLAG_ACTIVITY_NO_USER_ACTION一样intent的flag值为0，所以notTop为null；</span></div><div class="line">     ActivityRecord notTop =</div><div class="line">             (launchFlags &amp; Intent.FLAG_ACTIVITY_PREVIOUS_IS_TOP) != <span class="number">0</span> ? r : <span class="keyword">null</span>;</div><div class="line"></div><div class="line">     <span class="comment">// If the onlyIfNeeded flag is set, then we can do this if the activity</span></div><div class="line">     <span class="comment">// being launched is the same as the one making the call...  or, as</span></div><div class="line">     <span class="comment">// a special case, if we do not know the caller then we count the</span></div><div class="line">     <span class="comment">// current top activity as the caller.</span></div><div class="line">     <span class="keyword">if</span> ((startFlags&amp;ActivityManager.START_FLAG_ONLY_IF_NEEDED) != <span class="number">0</span>) &#123;</div><div class="line">         ...</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     <span class="keyword">boolean</span> addingToTask = <span class="keyword">false</span>;</div><div class="line">     TaskRecord reuseTask = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">     <span class="comment">// If the caller is not coming from another activity, but has given us an</span></div><div class="line">     <span class="comment">// explicit task into which they would like us to launch the new activity,</span></div><div class="line">     <span class="comment">// then let's see about doing that.</span></div><div class="line">     <span class="keyword">if</span> (sourceRecord == <span class="keyword">null</span> &amp;&amp; inTask != <span class="keyword">null</span> &amp;&amp; inTask.stack != <span class="keyword">null</span>) &#123;</div><div class="line">         ...</div><div class="line">     &#125; <span class="keyword">else</span> &#123;</div><div class="line">         inTask = <span class="keyword">null</span>;</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     <span class="keyword">if</span> (inTask == <span class="keyword">null</span>) &#123;</div><div class="line">         <span class="keyword">if</span> (sourceRecord == <span class="keyword">null</span>) &#123;</div><div class="line">             ...</div><div class="line">         &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sourceRecord.launchMode == ActivityInfo.LAUNCH_SINGLE_INSTANCE) &#123;</div><div class="line">             ...</div><div class="line">         &#125; <span class="keyword">else</span> <span class="keyword">if</span> (launchSingleInstance || launchSingleTask) &#123;</div><div class="line">             <span class="comment">// The activity being started is a single instance...  it always</span></div><div class="line">             <span class="comment">// gets launched into its own task.</span></div><div class="line">             <span class="comment">// launchFlags 设为Intent.FLAG_ACTIVITY_NEW_TASK</span></div><div class="line">             launchFlags |= Intent.FLAG_ACTIVITY_NEW_TASK;</div><div class="line">         &#125;</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     ActivityInfo newTaskInfo = <span class="keyword">null</span>;</div><div class="line">     Intent newTaskIntent = <span class="keyword">null</span>;</div><div class="line">     ActivityStack sourceStack;</div><div class="line">     <span class="keyword">if</span> (sourceRecord != <span class="keyword">null</span>) &#123;</div><div class="line">         <span class="keyword">if</span> (sourceRecord.finishing) &#123;</div><div class="line">             ...</div><div class="line">         &#125; <span class="keyword">else</span> &#123;</div><div class="line">             sourceStack = sourceRecord.task.stack;</div><div class="line">         &#125;</div><div class="line">     &#125; <span class="keyword">else</span> &#123;</div><div class="line">         sourceStack = <span class="keyword">null</span>;</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     <span class="keyword">boolean</span> movedHome = <span class="keyword">false</span>;</div><div class="line">     ActivityStack targetStack;</div><div class="line"></div><div class="line">     intent.setFlags(launchFlags);</div><div class="line">     <span class="keyword">final</span> <span class="keyword">boolean</span> noAnimation = (launchFlags &amp; Intent.FLAG_ACTIVITY_NO_ANIMATION) != <span class="number">0</span>;</div><div class="line"></div><div class="line">     <span class="comment">// 检索是否存在Task来放Activity；</span></div><div class="line">     <span class="keyword">if</span> (((launchFlags &amp; Intent.FLAG_ACTIVITY_NEW_TASK) != <span class="number">0</span> &amp;&amp;</div><div class="line">             (launchFlags &amp; Intent.FLAG_ACTIVITY_MULTIPLE_TASK) == <span class="number">0</span>)</div><div class="line">             || launchSingleInstance || launchSingleTask) &#123;</div><div class="line">         <span class="comment">// Activity的启动模式为launchSingleTask</span></div><div class="line">         <span class="keyword">if</span> (inTask == <span class="keyword">null</span> &amp;&amp; r.resultTo == <span class="keyword">null</span>) &#123;</div><div class="line">             <span class="comment">// 此时inTask为空 ， r.resultTo为空</span></div><div class="line">             <span class="comment">// 调用findTaskLocked，因为应用第一次启动，所以检索返回结果为null</span></div><div class="line">             ActivityRecord intentActivity = !launchSingleInstance ?</div><div class="line">                     findTaskLocked(r) : findActivityLocked(intent, r.info);</div><div class="line">             <span class="keyword">if</span> (intentActivity != <span class="keyword">null</span>) &#123;</div><div class="line">                 ...</div><div class="line">             &#125;</div><div class="line">         &#125;</div><div class="line">     &#125;</div><div class="line">     <span class="keyword">if</span> (r.packageName != <span class="keyword">null</span>) &#123;</div><div class="line">         <span class="comment">// 如果Activity与当前栈顶的Activity一致，判断是否再次启动。</span></div><div class="line">         ActivityStack topStack = mFocusedStack;</div><div class="line">         ActivityRecord top = topStack.topRunningNonDelayedActivityLocked(notTop);</div><div class="line">         <span class="keyword">if</span> (top != <span class="keyword">null</span> &amp;&amp; r.resultTo == <span class="keyword">null</span>) &#123;</div><div class="line">             <span class="keyword">if</span> (top.realActivity.equals(r.realActivity) &amp;&amp; top.userId == r.userId) &#123;</div><div class="line">                 ...</div><div class="line">             &#125;</div><div class="line">         &#125;</div><div class="line"></div><div class="line">     &#125; <span class="keyword">else</span> &#123;</div><div class="line">         ...</div><div class="line">     &#125;</div><div class="line">     <span class="keyword">boolean</span> newTask = <span class="keyword">false</span>;</div><div class="line">     <span class="keyword">boolean</span> keepCurTransition = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">     TaskRecord taskToAffiliate = launchTaskBehind &amp;&amp; sourceRecord != <span class="keyword">null</span> ?</div><div class="line">             sourceRecord.task : <span class="keyword">null</span>;</div><div class="line"></div><div class="line">     <span class="comment">// 参数r.resultTo为null，表示Launcher不需要等待启动MainActivity的执行结果</span></div><div class="line">     <span class="keyword">if</span> (r.resultTo == <span class="keyword">null</span> &amp;&amp; inTask == <span class="keyword">null</span> &amp;&amp; !addingToTask</div><div class="line">             &amp;&amp; (launchFlags &amp; Intent.FLAG_ACTIVITY_NEW_TASK) != <span class="number">0</span>) &#123;</div><div class="line">         newTask = <span class="keyword">true</span>;</div><div class="line">         targetStack = computeStackFocus(r, newTask);</div><div class="line">         targetStack.moveToFront(<span class="string">"startingNewTask"</span>);</div><div class="line">         <span class="comment">// 创建Task来启动Activity</span></div><div class="line">         <span class="keyword">if</span> (reuseTask == <span class="keyword">null</span>) &#123;</div><div class="line">             r.setTask(targetStack.createTaskRecord(getNextTaskId(),</div><div class="line">                     newTaskInfo != <span class="keyword">null</span> ? newTaskInfo : r.info,</div><div class="line">                     newTaskIntent != <span class="keyword">null</span> ? newTaskIntent : intent,</div><div class="line">                     voiceSession, voiceInteractor, !launchTaskBehind <span class="comment">/* toTop */</span>),</div><div class="line">                     taskToAffiliate);</div><div class="line">             ...</div><div class="line">         &#125; <span class="keyword">else</span> &#123;</div><div class="line">             ...</div><div class="line">         &#125;</div><div class="line">         ...</div><div class="line">         <span class="keyword">if</span> (!movedHome) &#123;</div><div class="line">             <span class="keyword">if</span> ((launchFlags &amp;</div><div class="line">                     (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_TASK_ON_HOME))</div><div class="line">                     == (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_TASK_ON_HOME)) &#123;</div><div class="line">                 <span class="comment">// Caller wants to appear on home activity, so before starting</span></div><div class="line">                 <span class="comment">// their own activity we will bring home to the front.</span></div><div class="line">                 r.task.setTaskToReturnTo(HOME_ACTIVITY_TYPE);</div><div class="line">             &#125;</div><div class="line">         &#125;</div><div class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sourceRecord != <span class="keyword">null</span>) &#123;</div><div class="line">         ...</div><div class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (inTask != <span class="keyword">null</span>) &#123;</div><div class="line">         ...</div><div class="line">     &#125; <span class="keyword">else</span> &#123;</div><div class="line">         ...</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     mService.grantUriPermissionFromIntentLocked(callingUid, r.packageName,</div><div class="line">             intent, r.getUriPermissionsLocked(), r.userId);</div><div class="line">     ...</div><div class="line">     targetStack.mLastPausedActivity = <span class="keyword">null</span>;</div><div class="line">     targetStack.startActivityLocked(r, newTask, doResume, keepCurTransition, options);</div><div class="line">     <span class="keyword">if</span> (!launchTaskBehind) &#123;</div><div class="line">         <span class="comment">// Don't set focus on an activity that's going to the back.</span></div><div class="line">         mService.setFocusedActivityLocked(r, <span class="string">"startedActivity"</span>);</div><div class="line">     &#125;</div><div class="line">     <span class="keyword">return</span> ActivityManager.START_SUCCESS;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>startActivityUncheckedLocked，从命名上可以猜出来方法执行Activity的检查操作。方法中获取到intent的启动标志，对启动模式重新设置，根据标志检索是否是否需要重新创建的Activity的对象、是否需要创建的任务栈、启动时Activity是否需要等待返回值等。然后调用<code>ActivityStack</code>的startActivityLocked方法。</p>
<figure class="highlight java"><figcaption><span>ActivityStack.java</span></figcaption><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">startActivityLocked</span><span class="params">(ActivityRecord r, <span class="keyword">boolean</span> newTask,</span></span></div><div class="line">        <span class="keyword">boolean</span> doResume, <span class="keyword">boolean</span> keepCurTransition, Bundle options) &#123;</div><div class="line">    ...</div><div class="line">    TaskRecord task = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">if</span> (!newTask) &#123;</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Place a new activity at top of stack, so it is next to interact</span></div><div class="line">    <span class="comment">// with the user.</span></div><div class="line">    </div><div class="line">    ...</div><div class="line"></div><div class="line">    task = r.task;</div><div class="line"></div><div class="line">    <span class="comment">// Slot the activity into the history stack and proceed</span></div><div class="line">    <span class="comment">// 压入历史栈后处理</span></div><div class="line">    task.addActivityToTop(r);</div><div class="line">    task.setFrontOfTask();</div><div class="line">    r.putInHistory();</div><div class="line">    <span class="keyword">if</span> (!isHomeStack() || numActivities() &gt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="comment">// We want to show the starting preview window if we are</span></div><div class="line">        <span class="comment">// switching to a new task, or the next activity's process is</span></div><div class="line">        <span class="comment">// not currently running.</span></div><div class="line">        ...</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// If this is the first activity, don't do any fancy animations,</span></div><div class="line">        <span class="comment">// because there is nothing for it to animate on top of.</span></div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (doResume) &#123;</div><div class="line">        mStackSupervisor.resumeTopActivitiesLocked(<span class="keyword">this</span>, r, options);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>startActivityLocked主要判断是否需要去进行任务切换时的界面操作。<br>接着调用ActivityStackSupervisor的resumeTopActivitiesLocked方法。<br><figure class="highlight java"><figcaption><span>ActivityStackSupervisor.java</span></figcaption><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">resumeTopActivitiesLocked</span><span class="params">(ActivityStack targetStack, ActivityRecord target,</span></span></div><div class="line">        Bundle targetOptions) &#123;</div><div class="line">    <span class="keyword">if</span> (targetStack == <span class="keyword">null</span>) &#123;</div><div class="line">        targetStack = mFocusedStack;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// Do targetStack first.</span></div><div class="line">    <span class="keyword">boolean</span> result = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">if</span> (isFrontStack(targetStack)) &#123;</div><div class="line">        result = targetStack.resumeTopActivityLocked(target, targetOptions);</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接着调用ActivityStack的resumeTopActivityLocked方法</p>
<figure class="highlight java"><figcaption><span>ActivityStack.java</span></figcaption><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">resumeTopActivityLocked</span><span class="params">(ActivityRecord prev)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> resumeTopActivityLocked(prev, <span class="keyword">null</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">resumeTopActivityLocked</span><span class="params">(ActivityRecord prev, Bundle options)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (mStackSupervisor.inResumeTopActivity) &#123;</div><div class="line">        <span class="comment">// Don't even start recursing.</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> result = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">// Protect against recursion. 保护防止递归</span></div><div class="line">        mStackSupervisor.inResumeTopActivity = <span class="keyword">true</span>;</div><div class="line">        <span class="keyword">if</span> (mService.mLockScreenShown == ActivityManagerService.LOCK_SCREEN_LEAVING) &#123;</div><div class="line">            mService.mLockScreenShown = ActivityManagerService.LOCK_SCREEN_HIDDEN;</div><div class="line">            mService.updateSleepIfNeededLocked();</div><div class="line">        &#125;</div><div class="line">        result = resumeTopActivityInnerLocked(prev, options);</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        mStackSupervisor.inResumeTopActivity = <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 确保栈顶Activity已经处于Resumed状态</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">resumeTopActivityInnerLocked</span><span class="params">(ActivityRecord prev, Bundle options)</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!mService.mBooting &amp;&amp; !mService.mBooted) &#123;</div><div class="line">        <span class="comment">//  服务还未启动</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">    ActivityRecord parent = mActivityContainer.mParentActivity;</div><div class="line">    <span class="keyword">if</span> ((parent != <span class="keyword">null</span> &amp;&amp; parent.state != ActivityState.RESUMED) ||</div><div class="line">            !mActivityContainer.isAttachedLocked()) &#123;</div><div class="line">        <span class="comment">// Do not resume this stack if its parent is not resumed.</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">    cancelInitializingActivities();</div><div class="line"></div><div class="line">    <span class="comment">// 找到栈顶ActivityRecord</span></div><div class="line">    <span class="keyword">final</span> ActivityRecord next = topRunningActivityLocked(<span class="keyword">null</span>);</div><div class="line"></div><div class="line">    <span class="comment">// Remember how we'll process this pause/resume situation, and ensure</span></div><div class="line">    <span class="comment">// that the state is reset however we wind up proceeding.</span></div><div class="line">    <span class="comment">// mUserLeaving保存在本地，重新设置为false</span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> userLeaving = mStackSupervisor.mUserLeaving;</div><div class="line">    mStackSupervisor.mUserLeaving = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> TaskRecord prevTask = prev != <span class="keyword">null</span> ? prev.task : <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">if</span> (next == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// There are no more activities!</span></div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    next.delayedResume = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    <span class="comment">// 如果栈顶Activity已经处于resume状态，直接返回</span></div><div class="line">    <span class="keyword">if</span> (mResumedActivity == next &amp;&amp; next.state == ActivityState.RESUMED &amp;&amp;</div><div class="line">                mStackSupervisor.allResumedActivitiesComplete()) &#123;</div><div class="line">        ...</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line"></div><div class="line">    <span class="comment">// 如果休眠状态并且没有需要resume的activity，栈顶activity处于暂停状态，直接返回</span></div><div class="line">    <span class="keyword">if</span> (mService.isSleepingOrShuttingDown()</div><div class="line">            &amp;&amp; mLastPausedActivity == next</div><div class="line">            &amp;&amp; mStackSupervisor.allPausedActivitiesComplete()) &#123;</div><div class="line">        ...</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 验证activity的拥有者已经启动</span></div><div class="line">    <span class="keyword">if</span> (mService.mStartedUsers.get(next.userId) == <span class="keyword">null</span>) &#123;</div><div class="line">        ...</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 如果activity正在等待停止或休眠，则从停止或休眠队列中移除这个activity</span></div><div class="line">    <span class="comment">// 因为不适应activity了</span></div><div class="line">    mStackSupervisor.mStoppingActivities.remove(next);</div><div class="line">    mStackSupervisor.mGoingToSleepActivities.remove(next);</div><div class="line">    next.sleeping = <span class="keyword">false</span>;</div><div class="line">    mStackSupervisor.mWaitingVisibleActivities.remove(next);</div><div class="line">    ...</div><div class="line">    <span class="comment">// 如果现在正在暂停一个activity，返回等待则进入等待状态。</span></div><div class="line">    <span class="keyword">if</span> (!mStackSupervisor.allPausedActivitiesComplete()) &#123;</div><div class="line">        ...</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">    ... </div><div class="line">    mStackSupervisor.setLaunchSource(next.info.applicationInfo.uid);</div><div class="line"></div><div class="line">    <span class="comment">// 在activity调用resumed之前需要暂停之前的activity</span></div><div class="line">    <span class="keyword">boolean</span> dontWaitForPause = (next.info.flags&amp;ActivityInfo.FLAG_RESUME_WHILE_PAUSING) != <span class="number">0</span>;</div><div class="line">    <span class="keyword">boolean</span> pausing = mStackSupervisor.pauseBackStacks(userLeaving, <span class="keyword">true</span>, dontWaitForPause);</div><div class="line">    <span class="keyword">if</span> (mResumedActivity != <span class="keyword">null</span>) &#123;</div><div class="line">        ...</div><div class="line">        <span class="comment">// 开始暂停之前的Activity，mResumedActivity指定启动时的Activity</span></div><div class="line">        pausing |= startPausingLocked(userLeaving, <span class="keyword">false</span>, <span class="keyword">true</span>, dontWaitForPause);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (pausing) &#123;</div><div class="line">        ...</div><div class="line">        <span class="comment">// At this point we want to put the upcoming activity's process</span></div><div class="line">        <span class="comment">// at the top of the LRU list, since we know we will be needing it</span></div><div class="line">        <span class="comment">// very soon and it would be a waste to let it get killed if it</span></div><div class="line">        <span class="comment">// happens to be sitting towards the end.</span></div><div class="line">        <span class="comment">// 如果正在暂停之前的activity，现在将要启动的activity的进程放在LRU列表的顶部，因为要很快要需要这个参数</span></div><div class="line">        <span class="comment">// </span></div><div class="line">        <span class="keyword">if</span> (next.app != <span class="keyword">null</span> &amp;&amp; next.app.thread != <span class="keyword">null</span>) &#123;</div><div class="line">            mService.updateLruProcessLocked(next.app, <span class="keyword">true</span>, <span class="keyword">null</span>);</div><div class="line">        &#125;</div><div class="line">        ...</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 执行Activity暂停操作</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* 保存mResumedActivity到本地变量prev中，在本文中mResumedActivity对应的就是Launcher。</div><div class="line">* 调用 Launcher对应的ApplicationThread对象的远程接口，也就是ApplicationThreadProxy。执行</div><div class="line">* ApplicationThreadProxy的schedulePauseActivity方法，经过底层驱动Binder，通知Launcher进入</div><div class="line">* Paused状态。</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">startPausingLocked</span><span class="params">(<span class="keyword">boolean</span> userLeaving, <span class="keyword">boolean</span> uiSleeping, <span class="keyword">boolean</span> resuming,</span></span></div><div class="line">        <span class="keyword">boolean</span> dontWait) &#123;</div><div class="line">    <span class="keyword">if</span> (mPausingActivity != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// 如果有暂停中的Activity</span></div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">    ActivityRecord prev = mResumedActivity;</div><div class="line">    <span class="keyword">if</span> (prev == <span class="keyword">null</span>) &#123;</div><div class="line">        ...</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (mActivityContainer.mParentActivity == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// Top level stack, not a child. Look for child stacks.</span></div><div class="line">        mStackSupervisor.pauseChildStacks(prev, userLeaving, uiSleeping, resuming, dontWait);</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">    <span class="comment">// 将mResumedActivity置空，mResumedActivity赋值给mPausingActivity</span></div><div class="line">    mResumedActivity = <span class="keyword">null</span>;</div><div class="line">    mPausingActivity = prev;</div><div class="line">    mLastPausedActivity = prev;</div><div class="line">    mLastNoHistoryActivity = (prev.intent.getFlags() &amp; Intent.FLAG_ACTIVITY_NO_HISTORY) != <span class="number">0</span></div><div class="line">            || (prev.info.flags &amp; ActivityInfo.FLAG_NO_HISTORY) != <span class="number">0</span> ? prev : <span class="keyword">null</span>;</div><div class="line">    prev.state = ActivityState.PAUSING;</div><div class="line">    prev.task.touchActiveTime();</div><div class="line">    clearLaunchTime(prev);</div><div class="line">    <span class="comment">// 启动的Activity</span></div><div class="line">    <span class="keyword">final</span> ActivityRecord next = mStackSupervisor.topRunningActivityLocked();</div><div class="line">    ...</div><div class="line">    <span class="keyword">if</span> (prev.app != <span class="keyword">null</span> &amp;&amp; prev.app.thread != <span class="keyword">null</span>) &#123;</div><div class="line">        ...</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            ...</div><div class="line">            prev.app.thread.schedulePauseActivity(prev.appToken, prev.finishing,</div><div class="line">                    userLeaving, prev.configChangeFlags, dontWait);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            ...</div><div class="line">            mPausingActivity = <span class="keyword">null</span>;</div><div class="line">            mLastPausedActivity = <span class="keyword">null</span>;</div><div class="line">            mLastNoHistoryActivity = <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        mPausingActivity = <span class="keyword">null</span>;</div><div class="line">        mLastPausedActivity = <span class="keyword">null</span>;</div><div class="line">        mLastNoHistoryActivity = <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>调用Launcher的ApplicationThread远程接口ApplicationThreadProxy的schedulePauseActivity方法</p>
<figure class="highlight java"><figcaption><span>ApplicationThreadProxy.java</span></figcaption><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">schedulePauseActivity</span><span class="params">(IBinder token, <span class="keyword">boolean</span> finished,</span></span></div><div class="line">        <span class="keyword">boolean</span> userLeaving, <span class="keyword">int</span> configChanges, <span class="keyword">boolean</span> dontReport) <span class="keyword">throws</span> RemoteException &#123;</div><div class="line">    Parcel data = Parcel.obtain();</div><div class="line">    data.writeInterfaceToken(IApplicationThread.descriptor);</div><div class="line">    data.writeStrongBinder(token);</div><div class="line">    data.writeInt(finished ? <span class="number">1</span> : <span class="number">0</span>);</div><div class="line">    data.writeInt(userLeaving ? <span class="number">1</span> :<span class="number">0</span>);</div><div class="line">    data.writeInt(configChanges);</div><div class="line">    data.writeInt(dontReport ? <span class="number">1</span> : <span class="number">0</span>);</div><div class="line">    <span class="comment">// </span></div><div class="line">    mRemote.transact(SCHEDULE_PAUSE_ACTIVITY_TRANSACTION, data, <span class="keyword">null</span>,</div><div class="line">            IBinder.FLAG_ONEWAY);</div><div class="line">    data.recycle();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>经过Binder驱动通知ApplicationThread指定对应的schedulePauseActivity方法。ApplicationThread为ActivityThread的内部类。</p>
<figure class="highlight java"><figcaption><span>ActivityThreadjava -> ApplicationThread.java ， H.java</span></figcaption><table><tr><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationThread</span> <span class="keyword">extends</span> <span class="title">ApplicationThreadNative</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">schedulePauseActivity</span><span class="params">(IBinder token, <span class="keyword">boolean</span> finished,</span></span></div><div class="line">            <span class="keyword">boolean</span> userLeaving, <span class="keyword">int</span> configChanges, <span class="keyword">boolean</span> dontReport) &#123;</div><div class="line">        sendMessage(</div><div class="line">                finished ? H.PAUSE_ACTIVITY_FINISHING : H.PAUSE_ACTIVITY,</div><div class="line">                token,</div><div class="line">                (userLeaving ? <span class="number">1</span> : <span class="number">0</span>) | (dontReport ? <span class="number">2</span> : <span class="number">0</span>),</div><div class="line">                configChanges);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 调用ActivityThread sendMessage发送Message，在H中处理Message</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sendMessage</span><span class="params">(<span class="keyword">int</span> what, Object obj, <span class="keyword">int</span> arg1, <span class="keyword">int</span> arg2, <span class="keyword">boolean</span> async)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    Message msg = Message.obtain();</div><div class="line">    msg.what = what;</div><div class="line">    msg.obj = obj;</div><div class="line">    msg.arg1 = arg1;   <span class="comment">// 1</span></div><div class="line">    msg.arg2 = arg2;  <span class="comment">// configChanges</span></div><div class="line">    <span class="keyword">if</span> (async) &#123;</div><div class="line">        msg.setAsynchronous(<span class="keyword">true</span>);</div><div class="line">    &#125;</div><div class="line">    mH.sendMessage(msg);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">H</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> LAUNCH_ACTIVITY         = <span class="number">100</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PAUSE_ACTIVITY          = <span class="number">101</span>;</div><div class="line">    ...</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">            ...</div><div class="line">            <span class="keyword">case</span> PAUSE_ACTIVITY:</div><div class="line">                ...</div><div class="line">                <span class="comment">// arg1 = 1 , </span></div><div class="line">                handlePauseActivity((IBinder)msg.obj, <span class="keyword">false</span>, (msg.arg1&amp;<span class="number">1</span>) != <span class="number">0</span>, msg.arg2,</div><div class="line">                        (msg.arg1&amp;<span class="number">2</span>) != <span class="number">0</span>);</div><div class="line">                ...</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            ...</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">//  最后调用handlePauseActivity</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handlePauseActivity</span><span class="params">(IBinder token, <span class="keyword">boolean</span> finished,</span></span></div><div class="line">        <span class="keyword">boolean</span> userLeaving, <span class="keyword">int</span> configChanges, <span class="keyword">boolean</span> dontReport) &#123;</div><div class="line">    ActivityClientRecord r = mActivities.get(token);</div><div class="line">    <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</div><div class="line">        ...</div><div class="line">        <span class="keyword">if</span> (userLeaving) &#123;</div><div class="line">            <span class="comment">// 1. 通知Activity，用户将要离开界面</span></div><div class="line">            performUserLeavingActivity(r);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        r.activity.mConfigChangeFlags |= configChanges;</div><div class="line">        <span class="comment">// 2. 调用Activity的onPaused方法。</span></div><div class="line">        performPauseActivity(token, finished, r.isPreHoneycomb());</div><div class="line"></div><div class="line">        <span class="comment">// Make sure any pending writes are now committed.</span></div><div class="line">        <span class="keyword">if</span> (r.isPreHoneycomb()) &#123;</div><div class="line">            QueuedWork.waitToFinish();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Tell the activity manager we have paused.</span></div><div class="line">        <span class="comment">// dontReport = (msg.arg1&amp;2) != 0 ; dontReport的值为false</span></div><div class="line">        <span class="keyword">if</span> (!dontReport) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="comment">// 3. 调用ActivityManager的远程服务接口 ActivityManagerProxy</span></div><div class="line">                <span class="comment">// 通知ActivityManagerService，当前activity已进入暂停状态，可以执行未完成任务。</span></div><div class="line">                ActivityManagerNative.getDefault().activityPaused(token);</div><div class="line">            &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        mSomeActivitiesChanged = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ActivityThread在方法<code>schedulePauseActivity</code>只简单的调用了sendMessage()方法。然后调用ActivityThread内部类H的handlePauseActivity方法，在handlePauseActivity中做了以下的任务：1. 将Binder引用的token转成ActivityRecord的远程接口ActivityClientRecord。如果userLeaving为true时，则调用performUserLeavingActivity来通知Activity，用户将要离开界面。3. 通知ActivityManagerService，当前activity已进入暂停状态，可以执行未完成任务。这里表示启动MainActivity。</p>
<figure class="highlight java"><figcaption><span>ActivityManagerNative.java -> ActivityManagerProxy.java</span></figcaption><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ActivityManagerProxy</span> <span class="keyword">implements</span> <span class="title">IActivityManager</span></span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">activityPaused</span><span class="params">(IBinder token)</span> <span class="keyword">throws</span> RemoteException</span></div><div class="line">    &#123;</div><div class="line">        Parcel data = Parcel.obtain();</div><div class="line">        Parcel reply = Parcel.obtain();</div><div class="line">        data.writeInterfaceToken(IActivityManager.descriptor);</div><div class="line">        data.writeStrongBinder(token);</div><div class="line">        mRemote.transact(ACTIVITY_PAUSED_TRANSACTION, data, reply, <span class="number">0</span>);</div><div class="line">        reply.readException();</div><div class="line">        data.recycle();</div><div class="line">        reply.recycle();</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>经过Binder驱动调用ActivityManagerService.activityPaused方法<br><figure class="highlight java"><figcaption><span>ActivityManager.java</span></figcaption><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">activityPaused</span><span class="params">(IBinder token)</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</div><div class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</div><div class="line">        ActivityStack stack = ActivityRecord.getStackLocked(token);</div><div class="line">        <span class="keyword">if</span> (stack != <span class="keyword">null</span>) &#123;</div><div class="line">            stack.activityPausedLocked(token, <span class="keyword">false</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>调用ActivityStack的activityPausedLocked 的方法</p>
<figure class="highlight java"><figcaption><span>ActivityStack.java</span></figcaption><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">activityPausedLocked</span><span class="params">(IBinder token, <span class="keyword">boolean</span> timeout)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="keyword">final</span> ActivityRecord r = isInStackLocked(token);</div><div class="line">    <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</div><div class="line">        ...</div><div class="line">        <span class="comment">// startPausingLocked时将当前Activity保存在mPausingActivity中。</span></div><div class="line">        <span class="keyword">if</span> (mPausingActivity == r) &#123;</div><div class="line">            ...</div><div class="line">            completePauseLocked(<span class="keyword">true</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            ... </div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">activityPausedLocked</span><span class="params">(IBinder token, <span class="keyword">boolean</span> timeout)</span> </span>&#123;</div><div class="line">    ...</div><div class="line"></div><div class="line">    <span class="keyword">final</span> ActivityRecord r = isInStackLocked(token);</div><div class="line">    <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</div><div class="line">        ...</div><div class="line">        <span class="comment">// startPausingLocked时将当前Activity保存在mPausingActivity中。</span></div><div class="line">        <span class="keyword">if</span> (mPausingActivity == r) &#123;</div><div class="line">            ...</div><div class="line">            completePauseLocked(<span class="keyword">true</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            ...</div><div class="line">            </div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 完成Activity的暂停任务</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">completePauseLocked</span><span class="params">(<span class="keyword">boolean</span> resumeNext)</span> </span>&#123;</div><div class="line">    ActivityRecord prev = mPausingActivity;</div><div class="line">    <span class="keyword">if</span> (prev != <span class="keyword">null</span>) &#123;</div><div class="line">        prev.state = ActivityState.PAUSED;</div><div class="line">        ...</div><div class="line">        <span class="comment">// 在activity暂停之前，会暂时冻住屏幕。这时Activity不再可见，则解除冻结状态</span></div><div class="line">        prev.stopFreezingScreenLocked(<span class="keyword">true</span> <span class="comment">/*force*/</span>);</div><div class="line">        mPausingActivity = <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// resumeNext值为true</span></div><div class="line">    <span class="keyword">if</span> (resumeNext) &#123;</div><div class="line">        <span class="comment">// resume 新的activity</span></div><div class="line">        <span class="keyword">final</span> ActivityStack topStack = mStackSupervisor.getFocusedStack();</div><div class="line">        <span class="keyword">if</span> (!mService.isSleepingOrShuttingDown()) &#123;</div><div class="line">            <span class="comment">// 如果没有休眠或关机</span></div><div class="line">            mStackSupervisor.resumeTopActivitiesLocked(topStack, prev, <span class="keyword">null</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            ...</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (prev != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// 恢复按键分发</span></div><div class="line">        prev.resumeKeyDispatchingLocked();</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 栈内容变化时发送通知。</span></div><div class="line">    mService.notifyTaskStackChangedLocked();</div><div class="line">&#125;    </div></pre></td></tr></table></figure>
<p>在方法completePauseLocked中：如果mPausingActivity不为空，则mPausingActivity需要置空。而mPausingActivity是在之前调用<code>startPausingLocked</code>保存的Launcher的实例，现在不需要这个临时对象了。获取的启动应用的栈信息，调用mStackSupervisor的resumeTopActivitiesLocked方法<br><figure class="highlight java"><figcaption><span>ActivityStackSupervisor.java</span></figcaption><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">resumeTopActivitiesLocked</span><span class="params">(ActivityStack targetStack, ActivityRecord target,</span></span></div><div class="line">        Bundle targetOptions) &#123;</div><div class="line">    ...     </div><div class="line">    <span class="keyword">boolean</span> result = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">if</span> (isFrontStack(targetStack)) &#123;</div><div class="line">        result = targetStack.resumeTopActivityLocked(target, targetOptions);</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>又执行了ActivityStack的resumeTopActivityLocked方法中。主要用作保护防止无限递归</p>
<figure class="highlight java"><figcaption><span>ActivityStack.java</span></figcaption><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">resumeTopActivityLocked</span><span class="params">(ActivityRecord prev, Bundle options)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="keyword">boolean</span> result = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">// Protect against recursion. </span></div><div class="line">        ...</div><div class="line">        result = resumeTopActivityInnerLocked(prev, options);</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">resumeTopActivityInnerLocked</span><span class="params">(ActivityRecord prev, Bundle options)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    cancelInitializingActivities();</div><div class="line"></div><div class="line">    <span class="comment">// Find the first activity that is not finishing. </span></div><div class="line">    <span class="comment">// 1. 找到栈顶Activity，也就是要启动的Activity。</span></div><div class="line">    <span class="keyword">final</span> ActivityRecord next = topRunningActivityLocked(<span class="keyword">null</span>);</div><div class="line"></div><div class="line">    ...</div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> userLeaving = mStackSupervisor.mUserLeaving;</div><div class="line">    mStackSupervisor.mUserLeaving = <span class="keyword">false</span>;</div><div class="line">    ... </div><div class="line">    <span class="keyword">final</span> TaskRecord prevTask = prev != <span class="keyword">null</span> ? prev.task : <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">if</span> (next == <span class="keyword">null</span>) &#123;</div><div class="line">        ...</div><div class="line">        <span class="keyword">return</span> isOnHomeDisplay() &amp;&amp;</div><div class="line">                mStackSupervisor.resumeHomeStackTask(returnTaskType, prev, reason);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    next.delayedResume = <span class="keyword">false</span>;</div><div class="line">    <span class="comment">// 2. mResumedActivity此时为空</span></div><div class="line">    <span class="keyword">if</span> (mResumedActivity == next &amp;&amp; next.state == ActivityState.RESUMED &amp;&amp;</div><div class="line">                mStackSupervisor.allResumedActivitiesComplete()) &#123;</div><div class="line">        ...</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> TaskRecord nextTask = next.task;</div><div class="line">    <span class="keyword">if</span> (prevTask != <span class="keyword">null</span> &amp;&amp; prevTask.stack == <span class="keyword">this</span> &amp;&amp;</div><div class="line">            prevTask.isOverHomeStack() &amp;&amp; prev.finishing &amp;&amp; prev.frontOfTask) &#123;</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 休眠状态或没有找到Activity需要执行resume直接返回</span></div><div class="line">    <span class="keyword">if</span> (mService.isSleepingOrShuttingDown()</div><div class="line">            &amp;&amp; mLastPausedActivity == next</div><div class="line">            &amp;&amp; mStackSupervisor.allPausedActivitiesComplete()) &#123;</div><div class="line">        ...</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ...</div><div class="line"></div><div class="line">    <span class="comment">// 暂停Activity已经执行，跳过</span></div><div class="line">    <span class="keyword">if</span> (!mStackSupervisor.allPausedActivitiesComplete()) &#123;</div><div class="line">        ...</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 设置启动信息</span></div><div class="line">    mStackSupervisor.setLaunchSource(next.info.applicationInfo.uid);</div><div class="line"></div><div class="line">    <span class="comment">// launcher已经暂停，跳过</span></div><div class="line">    <span class="keyword">boolean</span> dontWaitForPause = (next.info.flags&amp;ActivityInfo.FLAG_RESUME_WHILE_PAUSING) != <span class="number">0</span>;</div><div class="line">    <span class="keyword">boolean</span> pausing = mStackSupervisor.pauseBackStacks(userLeaving, <span class="keyword">true</span>, dontWaitForPause);</div><div class="line">    <span class="keyword">if</span> (mResumedActivity != <span class="keyword">null</span>) &#123;</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (pausing) &#123;</div><div class="line">        ...</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// 并不是休眠状态</span></div><div class="line">    <span class="keyword">if</span> (mService.isSleeping() &amp;&amp; mLastNoHistoryActivity != <span class="keyword">null</span> &amp;&amp;</div><div class="line">            !mLastNoHistoryActivity.finishing) &#123;</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (prev != <span class="keyword">null</span> &amp;&amp; prev != next) &#123;</div><div class="line">        <span class="keyword">if</span> (!mStackSupervisor.mWaitingVisibleActivities.contains(prev)</div><div class="line">                &amp;&amp; next != <span class="keyword">null</span> &amp;&amp; !next.nowVisible) &#123;</div><div class="line">            <span class="comment">// 将要启动的Acitivity添加等待显示的列表中</span></div><div class="line">            mStackSupervisor.mWaitingVisibleActivities.add(prev);</div><div class="line">            </div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line"></div><div class="line">            <span class="comment">// 如果之前的Acitivity消失了，执行这段代码。</span></div><div class="line">            ...</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Launching this app's activity, make sure the app is no longer</span></div><div class="line">    <span class="comment">// considered stopped.</span></div><div class="line">    <span class="comment">// 启动app，</span></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        AppGlobals.getPackageManager().setPackageStoppedState(</div><div class="line">                next.packageName, <span class="keyword">false</span>, next.userId); <span class="comment">/* <span class="doctag">TODO:</span> Verify if correct userid */</span></div><div class="line">    &#125; <span class="keyword">catch</span> (RemoteException e1) &#123;</div><div class="line">    &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</div><div class="line">       ...</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 开始启动新的Activity，通知WindowManager之前的Activity将会很快消失。这样</span></div><div class="line">    <span class="comment">// 在计算需求的屏幕方向时忽略它</span></div><div class="line">    <span class="keyword">boolean</span> anim = <span class="keyword">true</span>;</div><div class="line">    <span class="keyword">if</span> (prev != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// 为Activity准备Window基本参数配置，是否显示启动动画等</span></div><div class="line">        <span class="keyword">if</span> (prev.finishing) &#123;</div><div class="line">            ... </div><div class="line">            <span class="keyword">if</span> (mNoAnimActivities.contains(next)) &#123;</div><div class="line">                anim = <span class="keyword">false</span>;</div><div class="line">                ...</div><div class="line">            &#125;</div><div class="line">            ...</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            ...</div><div class="line">        &#125;</div><div class="line">        ...</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 执行resume时的动画参数</span></div><div class="line">    Bundle resumeAnimOptions = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">if</span> (anim) &#123;</div><div class="line">        <span class="comment">// </span></div><div class="line">        ActivityOptions opts = next.getOptionsForTargetActivityLocked();</div><div class="line">        <span class="keyword">if</span> (opts != <span class="keyword">null</span>) &#123;</div><div class="line">            resumeAnimOptions = opts.toBundle();</div><div class="line">        &#125;</div><div class="line">        ...</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">    <span class="comment">// 3. 获取最近的Activity栈信息</span></div><div class="line">    ActivityStack lastStack = mStackSupervisor.getLastStack();</div><div class="line">    <span class="keyword">if</span> (next.app != <span class="keyword">null</span> &amp;&amp; next.app.thread != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// 因为是从Launcher中第一次启动程序，所以程序没有这些进程和主线程信息。</span></div><div class="line">        ...</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        </div><div class="line">        <span class="comment">// 需要重启Activity：如正常启动程序或闪退后启动程序</span></div><div class="line">        <span class="keyword">if</span> (!next.hasBeenLaunched) &#123;</div><div class="line">            <span class="comment">// 之前没有启动过</span></div><div class="line">            next.hasBeenLaunched = <span class="keyword">true</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            ...</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 开始执行应用程序的进程和ActivityThread等重要参数的初始化操作</span></div><div class="line">        mStackSupervisor.startSpecificActivityLocked(next, <span class="keyword">true</span>, <span class="keyword">true</span>);</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div><div class="line"></div></pre></td></tr></table></figure>
<p>resumeTopActivityInnerLocked中执行的任务<br>1）取出栈顶Activity，也就是要启动的Activity。<br>2）Launcher此时已经处于Pasued状态，所以此时mResumedActivity为null，mLastPausedActivity为Launcher。<br>3）因为应用还未启动所以MainActivity的ActivityRecord的app和thread属性还未初始化，都为空，则调用ActivityStackSupervisor的startSpecificActivityLocked方法初始化应用的重要变量：ActivityThread等。</p>
<figure class="highlight java"><figcaption><span>ActivityStackSupervisor.java</span></figcaption><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">startSpecificActivityLocked</span><span class="params">(ActivityRecord r,</span></span></div><div class="line">        <span class="keyword">boolean</span> andResume, <span class="keyword">boolean</span> checkConfig) &#123;</div><div class="line">    <span class="comment">// Is this activity's application already running?</span></div><div class="line">    <span class="comment">// activity的application是否已经运行</span></div><div class="line">    ProcessRecord app = mService.getProcessRecordLocked(r.processName,</div><div class="line">            r.info.applicationInfo.uid, <span class="keyword">true</span>);</div><div class="line"> </div><div class="line">    r.task.stack.setLaunchTime(r);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (app != <span class="keyword">null</span> &amp;&amp; app.thread != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// 如果程序已经运行了，则执行realStartActivityLocked的流程</span></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            ...</div><div class="line">            realStartActivityLocked(r, app, andResume, checkConfig);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">            ...</div><div class="line">        &#125;</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 因为这时的应用还未启动则执行startProcessLocked方法，开启新的进程</span></div><div class="line">    mService.startProcessLocked(r.processName, r.info.applicationInfo, <span class="keyword">true</span>, <span class="number">0</span>,</div><div class="line">            <span class="string">"activity"</span>, r.intent.getComponent(), <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">true</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>因为首次的应用，所以取到的ProcessRecord为null。默认情况下，ActivityRecord中的进程名processName对应的就是在<code>AndroidManifest</code>中声明包名。调用ActivityManagerService的startProcessLocked方法来执行初始化任务。<br><figure class="highlight java"><figcaption><span>ActivityManagerService.java</span></figcaption><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> ProcessRecord <span class="title">startProcessLocked</span><span class="params">(String processName, ApplicationInfo info,</span></span></div><div class="line">        <span class="keyword">boolean</span> knownToBeDead, <span class="keyword">int</span> intentFlags, String hostingType, ComponentName hostingName,</div><div class="line">        <span class="keyword">boolean</span> allowWhileBooting, <span class="keyword">boolean</span> isolated, <span class="keyword">int</span> isolatedUid, <span class="keyword">boolean</span> keepIfLarge,</div><div class="line">        String abiOverride, String entryPoint, String[] entryPointArgs, Runnable crashHandler) &#123;</div><div class="line">    ...</div><div class="line">    ProcessRecord app;</div><div class="line">    <span class="comment">// isolated为true</span></div><div class="line">    <span class="keyword">if</span> (!isolated) &#123;</div><div class="line">        ...</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        ...</div><div class="line">        <span class="comment">// 如果是单独进程，则不能重用已存在的进程</span></div><div class="line">        app = <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">    <span class="comment">// 如果存在一个Application；</span></div><div class="line">    <span class="comment">// 调用者不认为已经死亡或没有线程对象时我们认为没有崩溃；</span></div><div class="line">    <span class="comment">// 或分配了一个进程id时，则认为正在启动或已经运行；</span></div><div class="line">    <span class="comment">// 这三种情况下，不会做任何事</span></div><div class="line">    <span class="keyword">if</span> (app != <span class="keyword">null</span> &amp;&amp; app.pid &gt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (!knownToBeDead || app.thread == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">// 已经运行App或等待出现（已经有进程id，但是还没有线程），则保留应用</span></div><div class="line">            ...</div><div class="line">            <span class="comment">// 如果是进程的新包，则添加新包到列表中</span></div><div class="line">            app.addPackage(info.packageName, info.versionCode, mProcessStats);</div><div class="line">            ...</div><div class="line">            <span class="keyword">return</span> app;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// app添加到之前的进程中，则清空进程</span></div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// host name</span></div><div class="line">    String hostingNameStr = hostingName != <span class="keyword">null</span></div><div class="line">            ? hostingName.flattenToShortString() : <span class="keyword">null</span>;</div><div class="line">    ...</div><div class="line">    <span class="keyword">if</span> (app == <span class="keyword">null</span>) &#123;</div><div class="line">        ...</div><div class="line">        <span class="comment">// 为app 创建新的进程</span></div><div class="line">        app = newProcessRecordLocked(info, processName, isolated, isolatedUid);</div><div class="line">        <span class="keyword">if</span> (app == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">        app.crashHandler = crashHandler;</div><div class="line">        ...</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// 如果是进程的新包，则添加新包到列表中</span></div><div class="line">        app.addPackage(info.packageName, info.versionCode, mProcessStats);</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 推迟进程启动直到系统准备好。</span></div><div class="line">    <span class="keyword">if</span> (!mProcessesReady</div><div class="line">            &amp;&amp; !isAllowedWhileBooting(info)</div><div class="line">            &amp;&amp; !allowWhileBooting) &#123;</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 开启进程</span></div><div class="line">    startProcessLocked(</div><div class="line">            app, hostingType, hostingNameStr, abiOverride, entryPoint, entryPointArgs);</div><div class="line">    ...</div><div class="line">    <span class="keyword">return</span> (app.pid != <span class="number">0</span>) ? app : <span class="keyword">null</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"> <span class="function"><span class="keyword">final</span> ProcessRecord <span class="title">newProcessRecordLocked</span><span class="params">(ApplicationInfo info, String customProcess,</span></span></div><div class="line">        <span class="keyword">boolean</span> isolated, <span class="keyword">int</span> isolatedUid) &#123;</div><div class="line">    <span class="comment">// 进程命名 ： processName+uid</span></div><div class="line">    String proc = customProcess != <span class="keyword">null</span> ? customProcess : info.processName;</div><div class="line">    BatteryStatsImpl stats = mBatteryStatsService.getActiveStatistics();</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> userId = UserHandle.getUserId(info.uid);</div><div class="line">    <span class="keyword">int</span> uid = info.uid;</div><div class="line">    <span class="keyword">if</span> (isolated) &#123;</div><div class="line">        <span class="comment">// isolatedUid 为 0</span></div><div class="line">        <span class="keyword">if</span> (isolatedUid == <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">int</span> stepsLeft = Process.LAST_ISOLATED_UID - Process.FIRST_ISOLATED_UID + <span class="number">1</span>;</div><div class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">                ...</div><div class="line">                uid = UserHandle.getUid(userId, mNextIsolatedProcessUid);</div><div class="line">                mNextIsolatedProcessUid++;</div><div class="line">                <span class="keyword">if</span> (mIsolatedProcesses.indexOfKey(uid) &lt; <span class="number">0</span>) &#123;</div><div class="line">                    <span class="comment">// No process for this uid, use it.</span></div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">                ...</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            ...</div><div class="line">            uid = isolatedUid;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">final</span> ProcessRecord r = <span class="keyword">new</span> ProcessRecord(stats, info, proc, uid);</div><div class="line">    ...</div><div class="line">    addProcessNameLocked(r);</div><div class="line">    <span class="keyword">return</span> r;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">addProcessNameLocked</span><span class="params">(ProcessRecord proc)</span> </span>&#123;</div><div class="line">    <span class="comment">// 清空旧进程</span></div><div class="line">    ProcessRecord old = removeProcessNameLocked(proc.processName, proc.uid);</div><div class="line">    <span class="keyword">if</span> (old == proc &amp;&amp; proc.persistent) &#123;</div><div class="line">        <span class="comment">// We are re-adding a persistent process.  Whatevs!  Just leave it there.</span></div><div class="line">        ...</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (old != <span class="keyword">null</span>) &#123;</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">    <span class="comment">// mProcessNames添加进程信息</span></div><div class="line">    mProcessNames.put(proc.processName, proc.uid, proc);</div><div class="line">    <span class="keyword">if</span> (proc.isolated) &#123;</div><div class="line">        mIsolatedProcesses.put(proc.uid, proc);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div></pre></td></tr></table></figure></p>
<p>ActivityManagerService的startProcessLocked方法：检查是否有对应的进程存在，如果没有进程（如启动新应用时），则<br>newProcessRecordLocked初始化进程基本参数：pid，uid，进程名等等。并保存在mProcessNames全局变量中。然后执行<code>startProcessLocked</code>方法，进入下一步。</p>
<figure class="highlight java"><figcaption><span>ActivityManagerService.java</span></figcaption><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">startProcessLocked</span><span class="params">(ProcessRecord app, String hostingType,</span></span></div><div class="line">        String hostingNameStr, String abiOverride, String entryPoint, String[] entryPointArgs) &#123;</div><div class="line">    ...</div><div class="line">    <span class="keyword">if</span> (app.pid &gt; <span class="number">0</span> &amp;&amp; app.pid != MY_PID) &#123;</div><div class="line">        ...</div><div class="line">        app.setPid(<span class="number">0</span>);</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">    mProcessesOnHold.remove(app);</div><div class="line">    ...</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        ...</div><div class="line">        <span class="keyword">int</span> uid = app.uid;</div><div class="line">        <span class="keyword">int</span>[] gids = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">int</span> mountExternal = Zygote.MOUNT_EXTERNAL_NONE;</div><div class="line">        <span class="keyword">if</span> (!app.isolated) &#123;</div><div class="line">            ...</div><div class="line">        &#125;</div><div class="line">        ...</div><div class="line">        <span class="keyword">if</span> (mFactoryTest != FactoryTest.FACTORY_TEST_OFF) &#123;</div><div class="line">            <span class="keyword">if</span> (mFactoryTest == FactoryTest.FACTORY_TEST_LOW_LEVEL</div><div class="line">                    &amp;&amp; mTopComponent != <span class="keyword">null</span></div><div class="line">                    &amp;&amp; app.processName.equals(mTopComponent.getPackageName())) &#123;</div><div class="line">                uid = <span class="number">0</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (mFactoryTest == FactoryTest.FACTORY_TEST_HIGH_LEVEL</div><div class="line">                    &amp;&amp; (app.info.flags&amp;ApplicationInfo.FLAG_FACTORY_TEST) != <span class="number">0</span>) &#123;</div><div class="line">                uid = <span class="number">0</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        ... </div><div class="line">        <span class="comment">// debug 标志</span></div><div class="line">        <span class="keyword">int</span> debugFlags = <span class="number">0</span>;</div><div class="line">        ...</div><div class="line">        String requiredAbi = (abiOverride != <span class="keyword">null</span>) ? abiOverride : app.info.primaryCpuAbi;</div><div class="line">        <span class="keyword">if</span> (requiredAbi == <span class="keyword">null</span>) &#123;</div><div class="line">            requiredAbi = Build.SUPPORTED_ABIS[<span class="number">0</span>];</div><div class="line">        &#125;</div><div class="line">        String instructionSet = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">if</span> (app.info.primaryCpuAbi != <span class="keyword">null</span>) &#123;</div><div class="line">            instructionSet = VMRuntime.getInstructionSet(app.info.primaryCpuAbi);</div><div class="line">        &#125;</div><div class="line">        app.gids = gids;</div><div class="line">        app.requiredAbi = requiredAbi;</div><div class="line">        app.instructionSet = instructionSet;</div><div class="line"></div><div class="line">        <span class="comment">// Start the process.  It will either succeed and return a result containing</span></div><div class="line">        <span class="comment">// the PID of the new process, or else throw a RuntimeException.</span></div><div class="line">        <span class="comment">// 启动进程，成功则返回含有新进程pid信息的结构，否则抛出异常。</span></div><div class="line">        <span class="keyword">boolean</span> isActivityProcess = (entryPoint == <span class="keyword">null</span>);</div><div class="line">        <span class="comment">// "android.app.ActivityThread"</span></div><div class="line">        <span class="keyword">if</span> (entryPoint == <span class="keyword">null</span>) entryPoint = <span class="string">"android.app.ActivityThread"</span>;</div><div class="line">        ...</div><div class="line">        <span class="comment">// 创建新的进程，</span></div><div class="line">        Process.ProcessStartResult startResult = Process.start(entryPoint,</div><div class="line">                app.processName, uid, uid, gids, debugFlags, mountExternal,</div><div class="line">                app.info.targetSdkVersion, app.info.seinfo, requiredAbi, instructionSet,</div><div class="line">                app.info.dataDir, entryPointArgs);</div><div class="line">        ...</div><div class="line">    &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</div><div class="line">        </div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Process的start方法向Zygote发送请求，传入”android.app.ActivityThread”字符串参数，通过Zygote执行fork子进程，初始化应用最终调用ActivityThread的main方法。</p>
<figure class="highlight java"><figcaption><span>ActivityThread.java</span></figcaption><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    SamplingProfilerIntegration.start();</div><div class="line">    ...</div><div class="line">    Environment.initForCurrentUser();</div><div class="line">    ...</div><div class="line">    AndroidKeyStoreProvider.install();</div><div class="line"></div><div class="line">    <span class="comment">// Make sure TrustedCertificateStore looks in the right place for CA certificates</span></div><div class="line">    <span class="keyword">final</span> File configDir = Environment.getUserConfigDirectory(UserHandle.myUserId());</div><div class="line">    TrustedCertificateStore.setDefaultUserDirectory(configDir);</div><div class="line"></div><div class="line">    Process.setArgV0(<span class="string">"&lt;pre-initialized&gt;"</span>);</div><div class="line">    <span class="comment">// 初始化MainLooper</span></div><div class="line">    Looper.prepareMainLooper();</div><div class="line">    <span class="comment">// 创建ActivityThread</span></div><div class="line">    ActivityThread thread = <span class="keyword">new</span> ActivityThread();</div><div class="line">    <span class="comment">// attach 调用attach方法</span></div><div class="line">    thread.attach(<span class="keyword">false</span>);</div><div class="line">    <span class="comment">// 主线程的sMainThreadHandler</span></div><div class="line">    <span class="keyword">if</span> (sMainThreadHandler == <span class="keyword">null</span>) &#123;</div><div class="line">        sMainThreadHandler = thread.getHandler();</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">    <span class="comment">// 开启主线程循环</span></div><div class="line">    Looper.loop();</div><div class="line">    ...</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(<span class="keyword">boolean</span> system)</span> </span>&#123;</div><div class="line">    sCurrentActivityThread = <span class="keyword">this</span>;</div><div class="line">    <span class="comment">// system值为false</span></div><div class="line">    mSystemThread = system;</div><div class="line">    <span class="keyword">if</span> (!system) &#123;</div><div class="line">        ...</div><div class="line">        RuntimeInit.setApplicationObject(mAppThread.asBinder());</div><div class="line">        <span class="keyword">final</span> IActivityManager mgr = ActivityManagerNative.getDefault();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// 调用ActivityManagerProxy进行远程通信。</span></div><div class="line">            mgr.attachApplication(mAppThread);</div><div class="line">        &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</div><div class="line">            <span class="comment">// Ignore</span></div><div class="line">        &#125;</div><div class="line">        ...</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// 不能设置Application对象。如果系统崩溃了，直接结束。</span></div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ActivityThread的main方法是整个应用程序启动的入口。执行了ActivityThread、主线程消息Looper的初始化操作。然后调用ActivityManagerProxy的attachApplication方法通过Binder驱动通知ActivityManagerService的attachApplication执行应用启动的后续操作。<br><figure class="highlight java"><figcaption><span>ActivityManagerService</span></figcaption><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">attachApplication</span><span class="params">(IApplicationThread thread)</span> </span>&#123;</div><div class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">        ...</div><div class="line">        attachApplicationLocked(thread, callingPid);</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">attachApplicationLocked</span><span class="params">(IApplicationThread thread,</span></span></div><div class="line">        <span class="keyword">int</span> pid) &#123;</div><div class="line"></div><div class="line">    <span class="comment">// Find the application record that is being attached...  either via</span></div><div class="line">    <span class="comment">// the pid if we are running in multiple processes, or just pull the</span></div><div class="line">    <span class="comment">// next app record if we are emulating process with anonymous threads.</span></div><div class="line"></div><div class="line">    <span class="comment">// 检索需要附加的application信息。</span></div><div class="line">    <span class="comment">// 1. 运行在多进程中pid信息;2. 或拉取用匿名线程模拟的进程启动的app信息。</span></div><div class="line">    ProcessRecord app;</div><div class="line">    <span class="keyword">if</span> (pid != MY_PID &amp;&amp; pid &gt;= <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">synchronized</span> (mPidsSelfLocked) &#123;</div><div class="line">            app = mPidsSelfLocked.get(pid);</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        app = <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (app == <span class="keyword">null</span>) &#123;</div><div class="line">        ...</div><div class="line">        <span class="comment">// 未找到application</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// If this application record is still attached to a previous</span></div><div class="line">    <span class="comment">// process, clean it up now.</span></div><div class="line">    <span class="comment">// 如果application record仍附加在之前的进程，则结束application</span></div><div class="line">    <span class="keyword">if</span> (app.thread != <span class="keyword">null</span>) &#123;</div><div class="line">        handleAppDiedLocked(app, <span class="keyword">true</span>, <span class="keyword">true</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 进程名：</span></div><div class="line">    <span class="keyword">final</span> String processName = app.processName;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        AppDeathRecipient adr = <span class="keyword">new</span> AppDeathRecipient(</div><div class="line">                app, pid, thread);</div><div class="line">        thread.asBinder().linkToDeath(adr, <span class="number">0</span>);</div><div class="line">        app.deathRecipient = adr;</div><div class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">        ...</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">    <span class="comment">// 激活进程状态</span></div><div class="line">    app.makeActive(thread, mProcessStats);</div><div class="line">    app.curAdj = app.setAdj = -<span class="number">100</span>;</div><div class="line">    app.curSchedGroup = app.setSchedGroup = Process.THREAD_GROUP_DEFAULT;</div><div class="line">    app.forcingToForeground = <span class="keyword">null</span>;</div><div class="line">    updateProcessForegroundLocked(app, <span class="keyword">false</span>, <span class="keyword">false</span>);</div><div class="line">    app.hasShownUi = <span class="keyword">false</span>;</div><div class="line">    app.debugging = <span class="keyword">false</span>;</div><div class="line">    ...</div><div class="line">    <span class="keyword">boolean</span> normalMode = mProcessesReady || isAllowedWhileBooting(app.info);</div><div class="line">    List&lt;ProviderInfo&gt; providers = normalMode ? generateApplicationProvidersLocked(app) : <span class="keyword">null</span>;</div><div class="line">    ...</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        ...</div><div class="line">        ApplicationInfo appInfo = app.instrumentationInfo != <span class="keyword">null</span></div><div class="line">                ? app.instrumentationInfo : app.info;</div><div class="line">        app.compat = compatibilityInfoForPackageLocked(appInfo);</div><div class="line">        <span class="keyword">if</span> (profileFd != <span class="keyword">null</span>) &#123;</div><div class="line">            profileFd = profileFd.dup();</div><div class="line">        &#125;</div><div class="line">        ProfilerInfo profilerInfo = profileFile == <span class="keyword">null</span> ? <span class="keyword">null</span></div><div class="line">                : <span class="keyword">new</span> ProfilerInfo(profileFile, profileFd, samplingInterval, profileAutoStop);</div><div class="line">        <span class="comment">// 1. 初始化应用中对应系统信息，</span></div><div class="line">        thread.bindApplication(processName, appInfo, providers, app.instrumentationClass,</div><div class="line">                profilerInfo, app.instrumentationArguments, app.instrumentationWatcher,</div><div class="line">                app.instrumentationUiAutomationConnection, testMode, enableOpenGlTrace,</div><div class="line">                enableTrackAllocation, isRestrictedBackupMode || !normalMode, app.persistent,</div><div class="line">                <span class="keyword">new</span> Configuration(mConfiguration), app.compat,</div><div class="line">                getCommonServicesLocked(app.isolated),</div><div class="line">                mCoreSettingsObserver.getCoreSettingsLocked());</div><div class="line">        updateLruProcessLocked(app, <span class="keyword">false</span>, <span class="keyword">null</span>);</div><div class="line">        ...</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">    <span class="keyword">boolean</span> badApp = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">boolean</span> didSomething = <span class="keyword">false</span>;</div><div class="line">    ... </div><div class="line">    <span class="comment">// 查看进程中是否有栈顶Activity等待运行</span></div><div class="line">    <span class="keyword">if</span> (normalMode) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// 2. 开始执行应用的MainActivity的启动操作。</span></div><div class="line">            <span class="keyword">if</span> (mStackSupervisor.attachApplicationLocked(app)) &#123;</div><div class="line">                didSomething = <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">           ...</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 查看进程中是否要运行的Service</span></div><div class="line">    <span class="keyword">if</span> (!badApp) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            didSomething |= mServices.attachApplicationLocked(app, processName);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            ...</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 查看进程中是否有要运行的Broadcast</span></div><div class="line">    <span class="keyword">if</span> (!badApp &amp;&amp; isPendingBroadcastProcessLocked(pid)) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            didSomething |= sendPendingBroadcastsLocked(app);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            ...</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><br>attachApplicationLocked中做了两个重要的事情</p>
<p>1）bindApplication：完成Application的实例化操作。通过Binder机制调用ApplicationThread的bindApplication，又会经过Handler发送Application绑定的操作，通过mInstrumentation来完成Application实例化，最后调用Application的onCreate()方法</p>
<p>2）attachApplicationLocked：接着步骤1）查找栈顶的Activity，如果存在MainActivity。则调用ActivityStackSupervisor的attachApplicationLocked方法执行启动Activity的任务。</p>
<figure class="highlight java"><figcaption><span>ActivityStackSupervisor.java</span></figcaption><table><tr><td class="code"><pre><div class="line"><span class="comment">// 查找需要启动的Activity。</span></div><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">attachApplicationLocked</span><span class="params">(ProcessRecord app)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</div><div class="line">    <span class="keyword">final</span> String processName = app.processName;</div><div class="line">    <span class="keyword">boolean</span> didSomething = <span class="keyword">false</span>;</div><div class="line">    <span class="comment">// 对所有任务栈循环</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> displayNdx = mActivityDisplays.size() - <span class="number">1</span>; displayNdx &gt;= <span class="number">0</span>; --displayNdx) &#123;</div><div class="line">        ArrayList&lt;ActivityStack&gt; stacks = mActivityDisplays.valueAt(displayNdx).mStacks;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> stackNdx = stacks.size() - <span class="number">1</span>; stackNdx &gt;= <span class="number">0</span>; --stackNdx) &#123;</div><div class="line">            <span class="comment">// </span></div><div class="line">            <span class="keyword">final</span> ActivityStack stack = stacks.get(stackNdx);</div><div class="line">            <span class="keyword">if</span> (!isFrontStack(stack)) &#123;</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// 如果是最前显示的栈，获取栈顶Activity的信息</span></div><div class="line">            ActivityRecord hr = stack.topRunningActivityLocked(<span class="keyword">null</span>);</div><div class="line">            <span class="keyword">if</span> (hr != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">if</span> (hr.app == <span class="keyword">null</span> &amp;&amp; app.uid == hr.info.applicationInfo.uid</div><div class="line">                        &amp;&amp; processName.equals(hr.processName)) &#123;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        <span class="comment">// 启动栈顶Activity</span></div><div class="line">                        <span class="keyword">if</span> (realStartActivityLocked(hr, app, <span class="keyword">true</span>, <span class="keyword">true</span>)) &#123;</div><div class="line">                            didSomething = <span class="keyword">true</span>;</div><div class="line">                        &#125;</div><div class="line">                    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">                        ...</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> didSomething;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">realStartActivityLocked</span><span class="params">(ActivityRecord r,</span></span></div><div class="line">        ProcessRecord app, <span class="keyword">boolean</span> andResume, <span class="keyword">boolean</span> checkConfig)</div><div class="line">        <span class="keyword">throws</span> RemoteException &#123;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (andResume) &#123;</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">    r.app = app;</div><div class="line">    app.waitingToKill = <span class="keyword">null</span>;</div><div class="line">    r.launchCount++;</div><div class="line">    r.lastLaunchTime = SystemClock.uptimeMillis();</div><div class="line">    ...</div><div class="line">    <span class="keyword">int</span> idx = app.activities.indexOf(r);</div><div class="line">    <span class="keyword">if</span> (idx &lt; <span class="number">0</span>) &#123;</div><div class="line">        app.activities.add(r);</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">    <span class="keyword">final</span> TaskRecord task = r.task;</div><div class="line">    <span class="keyword">final</span> ActivityStack stack = task.stack;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        ...</div><div class="line">        List&lt;ResultInfo&gt; results = <span class="keyword">null</span>;</div><div class="line">        List&lt;ReferrerIntent&gt; newIntents = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">if</span> (andResume) &#123;</div><div class="line">            results = r.results;</div><div class="line">            newIntents = r.newIntents;</div><div class="line">        &#125;</div><div class="line">        ...</div><div class="line">        <span class="keyword">if</span> (r.isHomeActivity() &amp;&amp; r.isNotResolverActivity()) &#123;</div><div class="line">            <span class="comment">// Home process is the root process of the task.</span></div><div class="line">            mService.mHomeProcess = task.mActivities.get(<span class="number">0</span>).app;</div><div class="line">        &#125;</div><div class="line">        ...</div><div class="line">        r.sleeping = <span class="keyword">false</span>;</div><div class="line">        r.forceNewConfig = <span class="keyword">false</span>;</div><div class="line">        mService.showAskCompatModeDialogLocked(r);</div><div class="line">        r.compat = mService.compatibilityInfoForPackageLocked(r.info.applicationInfo);</div><div class="line">        ProfilerInfo profilerInfo = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">if</span> (mService.mProfileApp != <span class="keyword">null</span> &amp;&amp; mService.mProfileApp.equals(app.processName)) &#123;</div><div class="line">            ...</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (andResume) &#123;</div><div class="line">            app.hasShownUi = <span class="keyword">true</span>;</div><div class="line">            app.pendingUiClean = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">        ...</div><div class="line">        <span class="comment">// 启动Activity</span></div><div class="line">        app.thread.scheduleLaunchActivity(<span class="keyword">new</span> Intent(r.intent), r.appToken,</div><div class="line">                System.identityHashCode(r), r.info, <span class="keyword">new</span> Configuration(mService.mConfiguration),</div><div class="line">                <span class="keyword">new</span> Configuration(stack.mOverrideConfig), r.compat, r.launchedFromPackage,</div><div class="line">                task.voiceInteractor, app.repProcState, r.icicle, r.persistentState, results,</div><div class="line">                newIntents, !andResume, mService.isNextTransitionForward(), profilerInfo);</div><div class="line">        ...</div><div class="line"></div><div class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>遍历所有Activity的任务找到最前显示的Activity的栈，取栈顶的Activity执行真正的Activity启动操作。同样需要Binder进行进程间通讯通知ApplicationThread执行scheduleLaunchActivity任务。</p>
<figure class="highlight java"><figcaption><span>ActivityThread.java -> ApplicationThread.java</span></figcaption><table><tr><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationThread</span> <span class="keyword">extends</span> <span class="title">ApplicationThreadNative</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">scheduleLaunchActivity</span><span class="params">(Intent intent, IBinder token, <span class="keyword">int</span> ident,</span></span></div><div class="line">            ActivityInfo info, Configuration curConfig, Configuration overrideConfig,</div><div class="line">            CompatibilityInfo compatInfo, String referrer, IVoiceInteractor voiceInteractor,</div><div class="line">            <span class="keyword">int</span> procState, Bundle state, PersistableBundle persistentState,</div><div class="line">            List&lt;ResultInfo&gt; pendingResults, List&lt;ReferrerIntent&gt; pendingNewIntents,</div><div class="line">            <span class="keyword">boolean</span> notResumed, <span class="keyword">boolean</span> isForward, ProfilerInfo profilerInfo) &#123;</div><div class="line"></div><div class="line">        updateProcessState(procState, <span class="keyword">false</span>);</div><div class="line"></div><div class="line">        ActivityClientRecord r = <span class="keyword">new</span> ActivityClientRecord();</div><div class="line"></div><div class="line">        r.token = token;</div><div class="line">        r.ident = ident;</div><div class="line">        r.intent = intent;</div><div class="line">        r.referrer = referrer;</div><div class="line">        r.voiceInteractor = voiceInteractor;</div><div class="line">        r.activityInfo = info;</div><div class="line">        r.compatInfo = compatInfo;</div><div class="line">        r.state = state;</div><div class="line">        r.persistentState = persistentState;</div><div class="line"></div><div class="line">        r.pendingResults = pendingResults;</div><div class="line">        r.pendingIntents = pendingNewIntents;</div><div class="line"></div><div class="line">        r.startsNotResumed = notResumed;</div><div class="line">        r.isForward = isForward;</div><div class="line"></div><div class="line">        r.profilerInfo = profilerInfo;</div><div class="line"></div><div class="line">        r.overrideConfig = overrideConfig;</div><div class="line">        updatePendingConfiguration(curConfig);</div><div class="line">        <span class="comment">// 发送启动的Activity的消息</span></div><div class="line">        sendMessage(H.LAUNCH_ACTIVITY, r);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">H</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">        ...</div><div class="line">        <span class="keyword">switch</span> (msg.what) &#123;</div><div class="line">            ...</div><div class="line">            <span class="keyword">case</span> LAUNCH_ACTIVITY: &#123;</div><div class="line">                ...</div><div class="line">                <span class="keyword">final</span> ActivityClientRecord r = (ActivityClientRecord) msg.obj;</div><div class="line">                ...</div><div class="line">                handleLaunchActivity(r, <span class="keyword">null</span>);</div><div class="line">                ...</div><div class="line">            &#125; <span class="keyword">break</span>;</div><div class="line">            ...</div><div class="line">        &#125;</div><div class="line">        ...</div><div class="line">    &#125;   </div><div class="line">    ...</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> </span>&#123;</div><div class="line"></div><div class="line">    mSomeActivitiesChanged = <span class="keyword">true</span>;</div><div class="line">    ...</div><div class="line">    <span class="comment">// 启动Activity前初始化WindowManager的全局属性</span></div><div class="line">    WindowManagerGlobal.initialize();</div><div class="line">    <span class="comment">// 1. 执行Activity的启动操作</span></div><div class="line">    Activity a = performLaunchActivity(r, customIntent);</div><div class="line">    <span class="comment">// 启动成功</span></div><div class="line">    <span class="keyword">if</span> (a != <span class="keyword">null</span>) &#123;</div><div class="line">        r.createdConfig = <span class="keyword">new</span> Configuration(mConfiguration);</div><div class="line">        <span class="comment">// 2. 执行Activity的resume操作</span></div><div class="line">        handleResumeActivity(r.token, <span class="keyword">false</span>, r.isForward,</div><div class="line">                !r.activity.mFinished &amp;&amp; !r.startsNotResumed);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (!r.activity.mFinished &amp;&amp; r.startsNotResumed) &#123;</div><div class="line">            ...</div><div class="line">            r.paused = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// 出现异常时直接结束Activity</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>先调用performLaunchActivity启动Activity，方法中执行Activity的onCreate()和start()方法。如果启动成功即返回的Activity不为null，则继续执行handleResumeActivity方法，方法中完成Activity调用onResume方法，完成整个Activity启动的过程。</p>
<figure class="highlight java"><figcaption><span>ActivityThread</span></figcaption><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Activity <span class="title">performLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> </span>&#123;</div><div class="line"></div><div class="line">    ActivityInfo aInfo = r.activityInfo;</div><div class="line">    <span class="keyword">if</span> (r.packageInfo == <span class="keyword">null</span>) &#123;</div><div class="line">        r.packageInfo = getPackageInfo(aInfo.applicationInfo, r.compatInfo,</div><div class="line">                Context.CONTEXT_INCLUDE_CODE);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 收集启动的Activity信息。</span></div><div class="line">    <span class="comment">// 创建Activity的相关组件</span></div><div class="line">    ComponentName component = r.intent.getComponent();</div><div class="line">    <span class="keyword">if</span> (component == <span class="keyword">null</span>) &#123;</div><div class="line">        component = r.intent.resolveActivity(</div><div class="line">            mInitialApplication.getPackageManager());</div><div class="line">        r.intent.setComponent(component);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (r.activityInfo.targetActivity != <span class="keyword">null</span>) &#123;</div><div class="line">        component = <span class="keyword">new</span> ComponentName(r.activityInfo.packageName,</div><div class="line">                r.activityInfo.targetActivity);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Activity activity = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">// 用ClassLoader加载MainActivity。实例化MainActivity</span></div><div class="line">        java.lang.ClassLoader cl = r.packageInfo.getClassLoader();</div><div class="line">        activity = mInstrumentation.newActivity(</div><div class="line">                cl, component.getClassName(), r.intent);</div><div class="line">        ...</div><div class="line">        r.intent.setExtrasClassLoader(cl);</div><div class="line">        r.intent.prepareToEnterProcess();</div><div class="line">        <span class="keyword">if</span> (r.state != <span class="keyword">null</span>) &#123;</div><div class="line">            r.state.setClassLoader(cl);</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        Application app = r.packageInfo.makeApplication(<span class="keyword">false</span>, mInstrumentation);</div><div class="line">        ...</div><div class="line">        <span class="keyword">if</span> (activity != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">// 创建Activity上下文信息。</span></div><div class="line">            Context appContext = createBaseContextForActivity(r, activity);</div><div class="line">            <span class="comment">// </span></div><div class="line">            CharSequence title = r.activityInfo.loadLabel(appContext.getPackageManager());</div><div class="line">            Configuration config = <span class="keyword">new</span> Configuration(mCompatConfiguration);</div><div class="line">            ...</div><div class="line"></div><div class="line">            activity.attach(appContext, <span class="keyword">this</span>, getInstrumentation(), r.token,</div><div class="line">                    r.ident, app, r.intent, r.activityInfo, title, r.parent,</div><div class="line">                    r.embeddedID, r.lastNonConfigurationInstances, config,</div><div class="line">                    r.referrer, r.voiceInteractor);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (customIntent != <span class="keyword">null</span>) &#123;</div><div class="line">                activity.mIntent = customIntent;</div><div class="line">            &#125;</div><div class="line">            r.lastNonConfigurationInstances = <span class="keyword">null</span>;</div><div class="line">            activity.mStartedActivity = <span class="keyword">false</span>;</div><div class="line">            <span class="keyword">int</span> theme = r.activityInfo.getThemeResource();</div><div class="line">            <span class="keyword">if</span> (theme != <span class="number">0</span>) &#123;</div><div class="line">                activity.setTheme(theme);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            activity.mCalled = <span class="keyword">false</span>;</div><div class="line">            <span class="comment">// 调用callActivityOnCreate方法</span></div><div class="line">            <span class="keyword">if</span> (r.isPersistable()) &#123;</div><div class="line">                mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                mInstrumentation.callActivityOnCreate(activity, r.state);</div><div class="line">            &#125;</div><div class="line">            ...</div><div class="line">            r.activity = activity;</div><div class="line">            r.stopped = <span class="keyword">true</span>;</div><div class="line">            <span class="keyword">if</span> (!r.activity.mFinished) &#123;</div><div class="line">                <span class="comment">// 调用start方法</span></div><div class="line">                activity.performStart();</div><div class="line">                r.stopped = <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (!r.activity.mFinished) &#123;</div><div class="line">                <span class="comment">// 如果是异常恢复则调用onRestoreInstanceState方法来恢复状态</span></div><div class="line">                <span class="keyword">if</span> (r.isPersistable()) &#123;</div><div class="line">                    <span class="keyword">if</span> (r.state != <span class="keyword">null</span> || r.persistentState != <span class="keyword">null</span>) &#123;</div><div class="line">                        mInstrumentation.callActivityOnRestoreInstanceState(activity, r.state,</div><div class="line">                                r.persistentState);</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r.state != <span class="keyword">null</span>) &#123;</div><div class="line">                    mInstrumentation.callActivityOnRestoreInstanceState(activity, r.state);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (!r.activity.mFinished) &#123;</div><div class="line">                activity.mCalled = <span class="keyword">false</span>;</div><div class="line">                <span class="comment">// </span></div><div class="line">                <span class="keyword">if</span> (r.isPersistable()) &#123;</div><div class="line">                    mInstrumentation.callActivityOnPostCreate(activity, r.state,</div><div class="line">                            r.persistentState);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    mInstrumentation.callActivityOnPostCreate(activity, r.state);</div><div class="line">                &#125;</div><div class="line">                ...</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        r.paused = <span class="keyword">true</span>;</div><div class="line">        <span class="comment">// 绑定token</span></div><div class="line">        mActivities.put(r.token, r);</div><div class="line">    &#125; <span class="keyword">catch</span> (SuperNotCalledException e) &#123;</div><div class="line">        <span class="keyword">throw</span> e;</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> activity;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>实例化Activity的组件信息，通过ClassLoader加载Activity，创建上下文信息附加到Activity中，然后由Instrumentation调用callActivityOnCreate等方法完成Activity启动时的生命周期方法，如onCreate()、onStart()等。<br><figure class="highlight java"><figcaption><span>Instrumentation.java</span></figcaption><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callActivityOnCreate</span><span class="params">(Activity activity, Bundle icicle)</span> </span>&#123;</div><div class="line">    prePerformCreate(activity);</div><div class="line">    <span class="comment">// 调用Activity的onCreate </span></div><div class="line">    activity.performCreate(icicle);</div><div class="line">    postPerformCreate(activity);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>到此，Android的应用程序启动与Activity相关的流程就完成了。<br>在整个流程中几个重要的类需要注意</p>
<ul>
<li><p><code>ActivityManagerNative</code> ：是Binder的子类，是底层Binder驱动在Java类中的实现。因为是抽象类，所以具体实现由ActivityManagerService来完成。</p>
</li>
<li><p><code>ActivityManagerService</code>：简称AMS，是Android中最核心的服务，主要负责Android的四大组件的启动、切换、是调度和应用进程的管理和调度工作（如Activity的生命周期控制）。在系统启动的时候完成AMS的注册。</p>
</li>
<li><p><code>ActivityManagerProxy</code> ：是ActivityManagerService的远程代理，客户端调用ActivityManagerProxy的相关方法通过Binder机制实现IPC，完成与ActivityManagerService通信交互任务。</p>
</li>
<li><p><code>ActivityThread</code> ：Application的入口，从main方法开始创建应用相关的核心功能。如主线程的消息循环，Application初始化，绑定Application相关的服务等等，同时控制组件的生命周期操作。对应Application的主线程。</p>
</li>
<li><p><code>ApplicationtThreadNative</code> ：与<code>ActivityManagerNative</code>一样也是Binder子类。具体实现由ApplicationThread完成。</p>
</li>
<li><p><code>ApplicationThread</code>：完成AMS与ActivityThread之间的通信。</p>
</li>
<li><p><code>ApplicationThreadProxy</code> ：是ApplicationThread远程接口代理。负责与客户端ApplicationThread通讯</p>
</li>
</ul>
<ul>
<li><p><code>Instrumentation</code> ：每个应用绑定唯一的一个Instrumentation，每个Activity都一个对该对象的引用。ActivityThread通过Instrumentation来控制Activity的生命周期。</p>
</li>
<li><p><code>ActivityStackSupervisor</code>： ActivityStack的超级管理员。</p>
</li>
<li><p><code>ActivityStack</code> ：用于保存Activity的栈，决定是否要启动新的进程。</p>
</li>
<li><p><code>ActivityRecord</code> ：用于Activity的信息存储，包括状态、进程名等。</p>
</li>
<li><p><code>TaskRecord</code> ：Android中的Task的具体实现。记录ActivityRecord的任务栈。</p>
</li>
</ul>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="https://developer.android.com/guide/components/activities.html" target="_blank" rel="external">Android Developer Activities</a></p>
<p><a href="http://blog.csdn.net/singwhatiwanna/article/details/9294285" target="_blank" rel="external">Activity的启动方式和flag详解</a></p>
<p><a href="http://blog.csdn.net/liuhe688/article/details/9494411" target="_blank" rel="external">Android 基础</a></p>
<p><a href="http://blog.csdn.net/innost/article/details/47317823" target="_blank" rel="external">深入理解Java Binder和MessageQueue</a></p>
<p><a href="http://blog.csdn.net/luoshengyang/article/details/6689748" target="_blank" rel="external">Android应用程序启动过程源代码分析</a></p>
<p><a href="http://blog.csdn.net/innost/article/details/47208049" target="_blank" rel="external">深入理解Binder</a></p>
<p><a href="http://www.jianshu.com/p/6037f6fda285" target="_blank" rel="external">【凯子哥带你学Framework】Activity启动过程全解析</a></p>


                <hr>

                

                <ul class="pager">
                    
                        <li class="previous">
                            <a href="/2016/06/28/Android：Handler、Message、MessageQueue、Looper/" data-toggle="tooltip" data-placement="top" title="Android：Handler、Message、MessageQueue、Looper">&larr; Previous Post</a>
                        </li>
                    
                    
                        <li class="next">
                            <a href="/2016/04/18/Android：NDK开发（二）/" data-toggle="tooltip" data-placement="top" title="Android NDK开发（二）：使用Android Studio开发进行NDK开发">Next Post &rarr;</a>
                        </li>
                    
                </ul>

                

                
                <!-- disqus 评论框 start -->
                <div class="comment">
                    <div id="disqus_thread" class="disqus-thread"></div>
                </div>
                <!-- disqus 评论框 end -->
                

            </div>
    <!-- Side Catalog Container -->
        

    <!-- Sidebar Container -->

            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                       
                          <a class="tag" href="/tags/#android-aosp" title="android-aosp">android-aosp</a>
                        
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
            </div>

        </div>
    </div>
</article>




<!-- disqus 公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = "alexwan02";
    var disqus_identifier = "http://blog.alexwan.cn/2016/06/05/Android：Activity的基础知识及启动过程/";
    var disqus_url = "http://blog.alexwan.cn/2016/06/05/Android：Activity的基础知识及启动过程/";

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<!-- disqus 公共JS代码 end -->




<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'always',
          placement: 'right',
          icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                
                
                
                    <li>
                        <a target="_blank" href="https://www.zhihu.com/people/alexwan02">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa  fa-stack-1x fa-inverse">知</i>
                            </span>
                        </a>
                    </li>
                

                

                

                
                    <li>
                        <a target="_blank"  href="https://github.com/alexwan02">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; Alex Studio 2017 
                    <br>
                    Theme by <a href="http://huangxuan.me">Hux</a> 
                    <span style="display: inline-block; margin: 0 5px;">
                        <i class="fa fa-heart"></i>
                    </span> 
                    Ported by <a href="http://blog.kaijun.rocks">Kaijun</a> | 
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="91px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=kaijun&repo=hexo-theme-huxblog&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js"></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- 
     Because of the native support for backtick-style fenced code blocks 
     right within the Markdown is landed in Github Pages, 
     From V1.6, There is no need for Highlight.js, 
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0  
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/    
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("http://blog.alexwan.cn/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->




<!-- Baidu Tongji -->


<!-- Side Catalog -->





<!-- Image to hack wechat -->
<img src="http://blog.alexwan.cn/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>


<!DOCTYPE html>
<html lang="zh">
    
<head>
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Alexwan Studio">
    <title>Kotlin基础之委托及委托属性 - Alexwan Studio</title>
    <meta name="author" content="alexwan">
    
        <link rel="icon" href="/assets/images/https://cdn.discordapp.com/icons/102860784329052160/109fd014c718f40110c4a182f105ca71.jpg">
    
    
        <link rel="alternative" type="application/atom+xml" title="RSS" href="/atom.xml">
    
    <meta name="description" content="委托类委托委托模式是替换继承的较好的设计模式，Kotlin天生支持委托模式，无须任何模板代码。类Derived可以继承Base接口，委托所有public方法给指定对象123456789101112131415interface Base &amp;#123;    fun print()&amp;#125;class BaseImpl(val x: Int) : Base &amp;#123;    override f">
<meta property="og:type" content="blog">
<meta property="og:title" content="Kotlin基础之委托及委托属性">
<meta property="og:url" content="http://blog.alexwan.cn/2017/07/06/Kotlin基础之委托及委托属性/index.html">
<meta property="og:site_name" content="Alexwan Studio">
<meta property="og:description" content="委托类委托委托模式是替换继承的较好的设计模式，Kotlin天生支持委托模式，无须任何模板代码。类Derived可以继承Base接口，委托所有public方法给指定对象123456789101112131415interface Base &amp;#123;    fun print()&amp;#125;class BaseImpl(val x: Int) : Base &amp;#123;    override f">
<meta property="og:updated_time" content="2017-07-06T02:27:37.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Kotlin基础之委托及委托属性">
<meta name="twitter:description" content="委托类委托委托模式是替换继承的较好的设计模式，Kotlin天生支持委托模式，无须任何模板代码。类Derived可以继承Base接口，委托所有public方法给指定对象123456789101112131415interface Base &amp;#123;    fun print()&amp;#125;class BaseImpl(val x: Int) : Base &amp;#123;    override f">
    
    
    
    
        <meta property="og:image" content="/2017/07/06/Kotlin基础之委托及委托属性/https://pic1.zhimg.com/v2-30253c279faba2e77120862dd54d49d4_r.jpg"/>
        <meta class="swiftype" name="image" data-type="enum" content="http://blog.alexwan.cn/2017/07/06/Kotlin基础之委托及委托属性/https://pic1.zhimg.com/v2-30253c279faba2e77120862dd54d49d4_r.jpg" />
    
    
    
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/style.min.css" type="text/css">
    <!--STYLES END-->
    
    <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-74386866-1']);
        _gaq.push(['_trackPageview']);
        (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
    </script>

</head>

    <body>
        <div id="blog">
            <header id="header" data-behavior="1">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <h1 class="header-title">
        <a class="header-title-link" href="/ ">Alexwan Studio</a>
    </h1>
    
        
            <a  class="header-right-icon st-search-show-outputs"
                href="/#search">
        
                <i class="fa fa-lg fa-search"></i>
            </a>
    
</header>
            <nav id="sidebar" data-behavior="1">
    
    
        <ul class="sidebar-buttons">
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/ "
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-home"></i>
                    <span class="sidebar-button-desc">主页</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/all-categories"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
                    <span class="sidebar-button-desc">分类</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/all-tags"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
                    <span class="sidebar-button-desc">标签</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/all-archives"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-bars"></i>
                    <span class="sidebar-button-desc">归档</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link st-search-show-outputs"
                         href="/#search"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-search"></i>
                    <span class="sidebar-button-desc">搜索</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/#about"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-question"></i>
                    <span class="sidebar-button-desc">关于</span>
                </a>
        </li>
        
    </ul>
    
        <ul class="sidebar-buttons">
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link " href="https://github.com/alexwan02" target="_blank">
                
                    <i class="sidebar-button-icon fa fa-lg fa-github-square"></i>
                    <span class="sidebar-button-desc">GitHub</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link " href="http://stackoverflow.com/users/4919743/alexwan1989" target="_blank">
                
                    <i class="sidebar-button-icon fa fa-lg fa-stack-overflow"></i>
                    <span class="sidebar-button-desc">Stack Overflow</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link " href="https://alexwan0312@gmail.com" target="_blank">
                
                    <i class="sidebar-button-icon fa fa-lg fa-envelope-o"></i>
                    <span class="sidebar-button-desc">Mail</span>
                </a>
        </li>
        
    </ul>
    
        <ul class="sidebar-buttons">
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/atom.xml"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
                    <span class="sidebar-button-desc">RSS</span>
                </a>
        </li>
        
    </ul>
    
</nav>

            
            <div id="main" data-behavior="1"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post" itemscope itemType="http://schema.org/BlogPosting">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title" itemprop="headline">
            Kotlin基础之委托及委托属性
        </h1>
    
    <div class="post-meta">
    <time itemprop="datePublished" content="Thu Jul 06 2017 10:27:37 GMT+0800">
	
		    Jul 06, 2017
    	
    </time>
    
</div>
</div>
    
    <div class="post-content markdown" itemprop="articleBody">
        <div class="main-content-wrap">
            <h1 id="u59D4_u6258"><a href="#u59D4_u6258" class="headerlink" title="委托"></a>委托</h1><h2 id="u7C7B_u59D4_u6258"><a href="#u7C7B_u59D4_u6258" class="headerlink" title="类委托"></a>类委托</h2><p><a href="https://en.wikipedia.org/wiki/Delegation_pattern" target="_blank" rel="external">委托模式</a>是替换继承的较好的设计模式，Kotlin天生支持委托模式，无须任何模板代码。类<code>Derived</code>可以继承<code>Base</code>接口，委托所有public方法给指定对象<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">interface Base &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">print</span><span class="params">()</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseImpl</span></span>(<span class="variable"><span class="keyword">val</span> x</span>: <span class="typename">Int</span>) : Base &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">print</span><span class="params">()</span> &#123; <span class="title">print</span><span class="params">(x)</span>&#125;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Derived</span></span>(b: Base) : Base by b</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">(args: <span class="typename">Array&lt;String&gt;</span>)</span>&#123;</span></span><br><span class="line">    <span class="variable"><span class="keyword">val</span> b</span> = BaseImpl(<span class="number">10</span>)</span><br><span class="line">    </span><br><span class="line">    Derived(b).print() <span class="comment">// 输出10</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>Derived</code>的超类列表中的<code>by</code>语句表示<code>b</code>会内部存储在<code>Derived</code>中，编译器会为<code>b</code>生成接口<code>Base</code>所有方法。</p>
<blockquote>
<p>复写可以与期望一样生效：编译器使用复写方法替换委托对象中的方法。如果在<code>Derived</code>中添加<code>override fun print() { print(&quot;abc&quot;) }</code>，程序则会输出<code>abc</code>，而不是<code>10</code></p>
</blockquote>
<h2 id="u59D4_u6258_u5C5E_u6027"><a href="#u59D4_u6258_u5C5E_u6027" class="headerlink" title="委托属性"></a>委托属性</h2><p>有一些普通类型属性，尽管可以在需要时每次手动实现，如果可以一次实现所有将会更好并放入到库中。包括：</p>
<ol>
<li>懒属性：只在第一次访问计算的值</li>
<li>观察属性：监听属性变化的通知</li>
<li>在map中存储属性，不是每个属性单个一个字段。</li>
</ol>
<p>为了覆盖这些案例，Kotlin支持委托属性<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Example</span> </span>&#123;</span><br><span class="line">    <span class="variable"><span class="keyword">var</span> p</span>: String by Delegate()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>语法为：<code>val/var &lt;property name&gt;: &lt;Type&gt; by &lt;expression&gt;</code>。跟在<code>by</code>之后的表达式为<code>Delegate</code>，因为属性对应的<code>get()</code>和<code>set()</code>则被委托给它的<code>getValue</code>和<code>setValue</code>方法。属性委托不用实现任何接口，但是要提供<code>getValue</code>和<code>setValue</code>方法（var类型属性）。比如<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Delegate</span> </span>&#123;</span><br><span class="line">    operator <span class="function"><span class="keyword">fun</span> <span class="title">getValue</span><span class="params">(thisRef: <span class="typename">Any? , property: KProperty&lt;*&gt;</span>)</span>: String&#123;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"$thisRef, thank you for delegating '$&#123;property.name&#125;' to me!"</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    operator <span class="function"><span class="keyword">fun</span> <span class="title">setValue</span><span class="params">(thisRef: <span class="typename">Any? , property: KProperty&lt;*&gt;, value: String</span>)</span>&#123;</span></span><br><span class="line">        println(<span class="string">"$value has been assigned to '$&#123;property.name&#125; in $thisRef.'"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>当读取委托给实例<code>Delegate</code>的<code>p</code>，则会调用<code>Delegate</code>的<code>getValue()</code>方法，它的第一个参数为<code>p</code>的对象，第二个参数持有<code>p</code>自己的描述（可以使用它的属性名）。如<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable"><span class="keyword">val</span> e</span> = Example()</span><br><span class="line">println(e.p)</span><br></pre></td></tr></table></figure></p>
<p>输出结果<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Example@<span class="number">33</span>a17727, thank you <span class="keyword">for</span> delegating ‘p’ to me!</span><br></pre></td></tr></table></figure></p>
<p>类似地，如果给<code>p</code>赋值，则调用<code>setValue()</code>函数，前两个参数一样，第三个为赋予的值<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">e.p = <span class="string">"NEW"</span></span><br></pre></td></tr></table></figure></p>
<p>输出结果<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NEW has been assigned to ‘p’ <span class="keyword">in</span> Example@<span class="number">33</span>a17727.</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>从Koltin 1.1开始，可以在函数中或代码块中声明委托属性。</p>
</blockquote>
<h2 id="u6807_u51C6_u59D4_u6258"><a href="#u6807_u51C6_u59D4_u6258" class="headerlink" title="标准委托"></a>标准委托</h2><p>Kotlin标准库提供几种有用类型的工厂方法，</p>
<h3 id="u61D2_u59D4_u6258"><a href="#u61D2_u59D4_u6258" class="headerlink" title="懒委托"></a>懒委托</h3><p><code>lazy()</code>函数输入lambda，返回<code>Lazy&lt;T&gt;</code>实例，可以作为实现懒属性的委托：第一次调用执行传入<code>lazy()</code>的lambda，并记住结果，之后调用get()，只返回记住的结果<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable"><span class="keyword">val</span> lazyValue</span>: String by lazy &#123;</span><br><span class="line">    println(<span class="string">"computed!"</span>)</span><br><span class="line">    <span class="string">"Hello"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">(args: <span class="typename">Array&lt;String&gt;</span>)</span> &#123;</span></span><br><span class="line">    println(lazyValue)</span><br><span class="line">    println(lazyValue)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>输出结果<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">computed!</span><br><span class="line">Hello</span><br><span class="line">Hello</span><br></pre></td></tr></table></figure></p>
<p>懒属性默认为同步赋值：只在一个线程中求值，所有线程都会看到相同的值。如果不需要同步初始化委托，那么多个线程可以同时执行，将<code>LazyThreadSafetyMode.PUBLICATION</code>作为参数传递给<code>lazy</code>函数。如果能够保证初始化在单线程中执行，那么可以使用<code>LazyThreadSafetyMode.NONE</code>模式，但不能保证线程安全和相关开销。</p>
<h2 id="u89C2_u5BDF_u8005"><a href="#u89C2_u5BDF_u8005" class="headerlink" title="观察者"></a>观察者</h2><p><a href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin.properties/-delegates/observable.html" target="_blank" rel="external">Delegates.observable()</a>有两个参数：初始值和修改处理Handler。每次给属性赋值时，都会调用handler（在赋值执行之后）。Handler有三个参数：被赋值的属性，旧值和新值<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> kotlin.properties.Delegate</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="variable"><span class="keyword">var</span> name</span>: String by Delegate.observable(<span class="string">"&lt;no name&gt;"</span>)&#123;</span><br><span class="line">        prop , old , new -&gt; </span><br><span class="line">        println(<span class="string">"$old -&gt; $new"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">(args: <span class="typename">Array&lt;String&gt;</span>)</span>&#123;</span></span><br><span class="line">    <span class="variable"><span class="keyword">val</span> user</span> = User()</span><br><span class="line">    user.name = <span class="string">"first"</span></span><br><span class="line">    user.name = <span class="string">"second"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>输出结果</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">&lt;no name&gt;</span> -&gt; first</span><br><span class="line">first -&gt; second</span><br></pre></td></tr></table></figure>
<p>如果希望拦截赋值并禁止它，使用<a href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin.properties/-delegates/vetoable.html" target="_blank" rel="external">vetoable()</a>替换<code>observable</code>。传给<code>vetoable</code>的handler在给属性赋新值前执行。</p>
<h2 id="u5728Map_u4E2D_u5B58_u50A8_u65B0_u503C"><a href="#u5728Map_u4E2D_u5B58_u50A8_u65B0_u503C" class="headerlink" title="在Map中存储新值"></a>在Map中存储新值</h2><p>我们通常使用Map来存储属性值，在应用中很常见，如解析JSON或其他动态的事。可以使用map实例本身作为委托属性的委托者。<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span>(<span class="variable"><span class="keyword">val</span> map</span>: Map<span class="type">&lt;String, Any?&gt;</span>) &#123;</span><br><span class="line">    <span class="variable"><span class="keyword">val</span> name</span>: String by map</span><br><span class="line">    <span class="variable"><span class="keyword">val</span> age</span>: <span class="typename">Int</span>     by map</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>构造器使用Map作为它的参数<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable"><span class="keyword">val</span> user</span> = User(mapOf(</span><br><span class="line">    <span class="string">"name"</span> to <span class="string">"John Doe"</span> , </span><br><span class="line">    <span class="string">"age"</span>  to <span class="number">25</span></span><br><span class="line">))</span><br></pre></td></tr></table></figure></p>
<p>委托属性按照属性名从Map中取值<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">println(user.name) <span class="comment">// Prints "John Doe"</span></span><br><span class="line">println(user.age)  <span class="comment">// Prints 25</span></span><br></pre></td></tr></table></figure></p>
<p>对于<code>var</code>属性，使用<code>MutableMap</code>来替换只读的<code>Map</code><br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MutableUser</span></span>(<span class="variable"><span class="keyword">val</span> map</span>: MutableMap<span class="type">&lt;String, Any?&gt;</span>) &#123;</span><br><span class="line">    <span class="variable"><span class="keyword">var</span> name</span>: String by map</span><br><span class="line">    <span class="variable"><span class="keyword">var</span> age</span>: <span class="typename">Int</span>     by map</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="u5C40_u90E8_u59D4_u6258_u5C5E_u6027_uFF08_u4ECE1-1_u5F00_u59CB_uFF09"><a href="#u5C40_u90E8_u59D4_u6258_u5C5E_u6027_uFF08_u4ECE1-1_u5F00_u59CB_uFF09" class="headerlink" title="局部委托属性（从1.1开始）"></a>局部委托属性（从1.1开始）</h2><p>从1.1开始可以声明局部变量为委托属性，如：创建局部懒属性<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">example</span><span class="params">(compute: <span class="typename">(</span>)</span> -&gt; Foo)&#123;</span></span><br><span class="line">    <span class="variable"><span class="keyword">val</span> memoizedFoo by lazy(computeFoo)</span><br><span class="line">    if (someCondition &amp;&amp; memoizedFoo.isValid()) &#123;</span><br><span class="line">        memoizedFoo.doSomething()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span></span><br></pre></td></tr></table></figure></p>
<p><code>memoizedFoo</code>属性只在第一次访问时进行计算，如果<code>someCondition</code>失败，则不会计算变量。</p>
<h2 id="u5C5E_u6027_u59D4_u6258_u8981_u6C42"><a href="#u5C5E_u6027_u59D4_u6258_u8981_u6C42" class="headerlink" title="属性委托要求"></a>属性委托要求</h2><p>下面总结委托对象的要求</p>
<ol>
<li><p>对于只读属性（val），委托对象提供名为<code>getValue</code>的函数，并带有下面几个参数</p>
<ul>
<li><code>thisRef</code> - 类型必须与属性对象的超类一致（对于扩展属性：扩展的类型）</li>
<li><code>property</code> - 必须为<code>KProperty&lt;*&gt;</code>或其子类</li>
<li>函数返回值必须与属性或其子类属性一致</li>
</ul>
</li>
<li><p>对于可变属性（var）, 委托对象需要额外提供名为<code>setValue</code>的函数，并带有下面几个参数</p>
<ul>
<li><code>thisRef</code> - 必须与<code>getValue()</code>一样</li>
<li><code>property</code> - 与<code>getValue()</code>一样</li>
<li>新值 - 类型必须与属性对象的超类一致</li>
</ul>
</li>
</ol>
<p><code>getValue()</code>和（或）<code>setValue()</code>可能会作为委托对象的成员函数或扩展函数，当需要委托属性给对象时（没有这些函数）时，扩展函数会比较方便。这两种函数都需要使用<code>operator</code>关键字来标记。</p>
<p>委托类可以实现<code>ReadOnlyProperty</code>或<code>ReadWriteProperty</code>其中一个接口，包含需要的<code>operator</code>方法。Kotlin标准库声明了这些接口。<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">interface ReadOnlyProperty<span class="type">&lt;in R, out T&gt;</span> &#123;</span><br><span class="line">    operator <span class="function"><span class="keyword">fun</span> <span class="title">getValue</span><span class="params">(thisRef: <span class="typename">R, property: KProperty&lt;*&gt;</span>)</span>: T</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">interface ReadWriteProperty<span class="type">&lt;in R, T&gt;</span> &#123;</span><br><span class="line">    operator <span class="function"><span class="keyword">fun</span> <span class="title">getValue</span><span class="params">(thisRef: <span class="typename">R, property: KProperty&lt;*&gt;</span>)</span>: T</span></span><br><span class="line">    operator <span class="function"><span class="keyword">fun</span> <span class="title">setValue</span><span class="params">(thisRef: <span class="typename">R, property: KProperty&lt;*&gt;, value: T</span>)</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="u8F6C_u6362_u89C4_u5219"><a href="#u8F6C_u6362_u89C4_u5219" class="headerlink" title="转换规则"></a>转换规则</h2><p>每个委托属性的内在机制：Kotlin编译器会生成一个辅助属性，并委托给为委托属性。例如：<code>prop</code>会生成<code>prop$delegate</code>隐藏属性，访问者的代码只委托给了附加的属性：<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span>&#123;</span><br><span class="line">    <span class="variable"><span class="keyword">var</span> prop</span>: Type by MyDelegate()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 编译器会生成下面的代码</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable"><span class="keyword">val</span> prop</span>$delegate = MyDelegate()</span><br><span class="line">    <span class="variable"><span class="keyword">var</span> prop</span>: Type</span><br><span class="line">        <span class="keyword">get</span>() = prop$delegate.getValue(this, this::prop)</span><br><span class="line">        <span class="keyword">set</span>(value: Type) = prop$delegate.setValue(this, this::prop, value)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Koltin编译器提供有关prop的所有的必要信息：第一个参数<code>this</code>是外部类C的引用，<code>this::prop</code>是<code>KProperty</code>类型的反射对象，描述<code>prop</code>。</p>
<blockquote>
<p><code>this::prop</code>语法表示直接<a href="https://kotlinlang.org/docs/reference/reflection.html#bound-function-and-property-references-since-11" target="_blank" rel="external">绑定调用</a>代码中的应用，在Kotlin1.1后可用</p>
</blockquote>
<h2 id="u63D0_u4F9B_u59D4_u6258_uFF08_u4ECE1-1_u5F00_u59CB_uFF09"><a href="#u63D0_u4F9B_u59D4_u6258_uFF08_u4ECE1-1_u5F00_u59CB_uFF09" class="headerlink" title="提供委托（从1.1开始）"></a>提供委托（从1.1开始）</h2><p>定义<code>provideDelegate</code>操作函数，可以继承创建对象给委托属性的逻辑。如果给在<code>by</code>右边使用的对象，定了成员函数或扩展函数<code>provideDelegate</code>，则创建委托属性时调用这个函数。</p>
<p>使用<code>provideDelegate</code>的一种情况就是：在创建属性时，检查属性一致性，不仅仅是在<code>getter</code>和<code>setter</code>中。</p>
<p>如：希望在绑定前，检查属性名，可以这样做<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ResourceLoader</span>&lt;<span class="type">T</span>&gt;</span>(id: ResourceID<span class="type">&lt;T&gt;</span>) &#123;</span><br><span class="line">    operator <span class="function"><span class="keyword">fun</span> <span class="title">provideDelegate</span><span class="params">(</span><br><span class="line">            thisRef: <span class="typename">MyUI,</span><br><span class="line">            prop: KProperty&lt;*&gt;</span></span><br><span class="line">    )</span>: ReadOnlyProperty<span class="type">&lt;MyUI, T&gt;</span> &#123;</span></span><br><span class="line">        checkProperty(thisRef, prop.name)</span><br><span class="line">        <span class="comment">// create delegate</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">checkProperty</span><span class="params">(thisRef: <span class="typename">MyUI, name: String</span>)</span> &#123; ... &#125;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> <span class="title">bindResource</span><span class="params">(id: <span class="typename">ResourceID&lt;T&gt;</span>)</span>: ResourceLoader<span class="type">&lt;T&gt;</span> &#123; ... &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyUI</span> </span>&#123;</span><br><span class="line">    <span class="variable"><span class="keyword">val</span> image by bindResource(ResourceID.image_id)</span><br><span class="line">    <span class="keyword">val</span> text by bindResource(ResourceID.text_id)</span><br><span class="line">&#125;</span></span><br></pre></td></tr></table></figure></p>
<p><code>provideDelegate</code>参数与<code>getValue</code>一样</p>
<ul>
<li><code>thisRef</code> - 类型必须与属性对象的超类一致（对于扩展属性：扩展的类型）</li>
<li><code>property</code> - 必须为<code>KProperty&lt;*&gt;</code>或其子类</li>
</ul>
<p>在创建<code>MyUI</code>实例时，调用每个属性的<code>provideDelegate</code>方法，立即执行必要的验证</p>
<p>不能够拦截<code>property</code>和委托类的绑定操作，可以显性传入属性名来达到这个效果。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyUI</span> </span>&#123;</span><br><span class="line">    <span class="variable"><span class="keyword">val</span> image by bindResource(ResourceID.image_id, "image")</span><br><span class="line">    <span class="keyword">val</span> text by bindResource(ResourceID.text_id, "text")</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fun &lt;T&gt; MyUI.bindResource(</span><br><span class="line">        id</span>: ResourceID<span class="type">&lt;T&gt;</span>,</span><br><span class="line">        propertyName: String</span><br><span class="line">): ReadOnlyProperty<span class="type">&lt;MyUI, T&gt;</span> &#123;</span><br><span class="line">   checkProperty(this, propertyName)</span><br><span class="line">   <span class="comment">// create delegate</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在生成的代码中，<code>provideDelegate</code>方法用来初始化<code>prop$delegate</code>属性。对比上面<code>val prop: Type by MyDelegate()</code>未声明<code>provideDelegate</code>方式生成的代码：<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> </span>&#123;</span><br><span class="line">    <span class="variable"><span class="keyword">var</span> prop</span>: Type by MyDelegate()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 编译器生成下面的代码</span></span><br><span class="line"><span class="comment">// 提供provideDelegate函数时</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 调用 "provideDelegate" 创建 "delegate" 属性</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable"><span class="keyword">val</span> prop</span>$delegate = MyDelegate().provideDelegate(this, this::prop)</span><br><span class="line">    <span class="variable"><span class="keyword">val</span> prop</span>: Type</span><br><span class="line">        <span class="keyword">get</span>() = prop$delegate.getValue(this, this::prop)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p><code>provideDelegate</code>方法只影响辅助属性的创建，不影响生成的getter和setter代码。</p>
</blockquote>

            
                

            
        </div>
    </div>
    <div class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">TAGGED IN</span><br/>
                
    <a class="tag tag--primary tag--small t-link" href="/tags/kotlin/">kotlin</a>

            </div>
        
        <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--disabled">
                
                    <i class="fa fa-angle-left"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">上一篇</span>
                </a>
            </li>
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2017/07/06/Kotlin基础之对象表达式与声明/" data-tooltip="Kotlin基础之对象表达式与声明">
                
                    <span class="hide-xs hide-sm text-small icon-mr">下一篇</span>
                    <i class="fa fa-angle-right"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions"  href="#btn-open-shareoptions">
                <i class="fa fa-share-alt"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" data-tooltip="分享至Google+" href="https://plus.google.com/share?url=http://blog.alexwan.cn/2017/07/06/Kotlin基础之委托及委托属性/">
                <i class="fa fa-google-plus"></i>
            </a>
        </li>
       
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" data-tooltip="分享至Twitter" href="https://twitter.com/intent/tweet?text=http://blog.alexwan.cn/2017/07/06/Kotlin基础之委托及委托属性/">
                <i class="fa fa-twitter"></i>
            </a>
        </li>

         <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" data-tooltip="分享至新浪微博" href="http://www.jiathis.com/send/?webid=tsina&amp;appkey=&amp;uid=1850331&amp;url=http://blog.alexwan.cn/2017/07/06/Kotlin基础之委托及委托属性/&amp;title=Kotlin基础之委托及委托属性">
                <i class="fa fa-weibo"></i>
            </a>
        </li>

        
            <li class="post-action">
                <a class="post-action-btn btn btn--default" href="#disqus_thread">
                    <i class="fa fa-comment-o"></i>
                </a>
            </li>
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#">
            
                <i class="fa fa-list"></i>
            </a>
        </li>
    </ul>
</div>


        
            <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2017 alexwan. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="1">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--disabled">
                
                    <i class="fa fa-angle-left"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">上一篇</span>
                </a>
            </li>
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2017/07/06/Kotlin基础之对象表达式与声明/" data-tooltip="Kotlin基础之对象表达式与声明">
                
                    <span class="hide-xs hide-sm text-small icon-mr">下一篇</span>
                    <i class="fa fa-angle-right"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions"  href="#btn-open-shareoptions">
                <i class="fa fa-share-alt"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" data-tooltip="分享至Google+" href="https://plus.google.com/share?url=http://blog.alexwan.cn/2017/07/06/Kotlin基础之委托及委托属性/">
                <i class="fa fa-google-plus"></i>
            </a>
        </li>
       
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" data-tooltip="分享至Twitter" href="https://twitter.com/intent/tweet?text=http://blog.alexwan.cn/2017/07/06/Kotlin基础之委托及委托属性/">
                <i class="fa fa-twitter"></i>
            </a>
        </li>

         <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" data-tooltip="分享至新浪微博" href="http://www.jiathis.com/send/?webid=tsina&amp;appkey=&amp;uid=1850331&amp;url=http://blog.alexwan.cn/2017/07/06/Kotlin基础之委托及委托属性/&amp;title=Kotlin基础之委托及委托属性">
                <i class="fa fa-weibo"></i>
            </a>
        </li>

        
            <li class="post-action">
                <a class="post-action-btn btn btn--default" href="#disqus_thread">
                    <i class="fa fa-comment-o"></i>
                </a>
            </li>
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#">
            
                <i class="fa fa-list"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                <div id="share-options-bar" class="share-options-bar" data-behavior="1">
    <ul class="share-options">
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://plus.google.com/share?url=http://blog.alexwan.cn/2017/07/06/Kotlin基础之委托及委托属性/">
                <i class="fa fa-google-plus"></i><span class="">Share on Google Plus</span>
            </a>
        </li>
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://blog.alexwan.cn/2017/07/06/Kotlin基础之委托及委托属性/">
                <i class="fa fa-facebook-official"></i><span>Share on Facebook</span>
            </a>
        </li>
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=http://blog.alexwan.cn/2017/07/06/Kotlin基础之委托及委托属性/">
                <i class="fa fa-twitter"></i><span>Share on Twitter</span>
            </a>
        </li>
    </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>
            
        </div>
        <div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-remove"></i>
        </div>
        
            <h4 id="about-card-name">alexwan</h4>
        
            <h5 id="about-card-bio"><p>无限大な梦のあとの 何もない世の中じゃ!</p>
</h5>
        
        
            <h5 id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>Android Developer</p>

            </h5>
        
        
            <h5 id="about-card-location">
                <i class="fa fa-map-marker"></i>
                <br/>
                China ShangHai
            </h5>
        
    </div>
</div>

        <div id="cover" style="background-image:url('http://imgbucket-1252300500.picsh.myqcloud.com/github/body_bg_page.jpg');"></div>

    </body>
    <!--SCRIPTS-->
<script src="/assets/js/script.min.js" type="text/javascript"></script>
<!--SCRIPTS END-->

    <script type="text/javascript">
        var disqus_shortname = 'alexwan';
        (function() {
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>



</html>
